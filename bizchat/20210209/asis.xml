<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skt.mate.model.mapper.user.UserInfoMapper">	
	
	<resultMap id="CustomUserMap" type="com.skt.mate.model.domain.user.CustomUserVO" extends="common.CommonMap">
		<result property="userId" 			column="user_id"			/>
		<result property="userTpCd" 		column="user_tp_cd"			/>
		<result property="userNm" 			column="user_nm"			/>
		<result property="userDesc"			column="user_desc"			/>
		<result property="bizRegNum" 		column="biz_reg_num"		/>
		<result property="bizRegCertiPath" 	column="biz_reg_certi_path"	/>
		<result property="bizCate" 			column="biz_cate"			/>
		<result property="bizStatus"		column="biz_status"			/>
		<result property="ceoNm" 			column="ceo_nm"				/>
		<result property="repNum" 			column="rep_num"			/>
		<result property="fax"     			column="fax" 				/>
		<result property="addr"    			column="addr"				/>
		<result property="accessKey" 		column="access_key"			/>
		<result property="encryKey"   		column="encry_key" 			/>
		<result property="stateCd"  		column="state_cd"			/>
		<result property="blcId"			column="blc_id"				/>
		<result property="rlcId"			column="rlc_id"				/>
		<result property="dlcId"			column="dlc_id"				/>
		<result property="blcNm"			column="blc_nm"				/>
		<result property="rlcNm"			column="rlc_nm"				/>
		<result property="dlcNm"			column="dlc_nm"				/>
	</resultMap>
	<select id="selectCustomUserList" parameterType="com.skt.mate.model.domain.user.CustomUserVO" resultMap="CustomUserMap">
		SELECT /* [user/userInfo.sqlmap.xml].[selectCustomUserList] by hwkim */
			   a.user_id
			 , a.user_nm
		  FROM system_user a
		 WHERE EXISTS (
						SELECT '1'
						  FROM custom b
						 WHERE b.user_id = a.user_id
						 <if test="@MybatisUtils@isNotEmpty(customUserId)">
						 AND b.user_id = #{customUserId}
						 </if>
						 <if test="@MybatisUtils@isNotEmpty(blcId)">
						 AND b.blc_id= #{blcId}
						 </if>
						 <if test="@MybatisUtils@isNotEmpty(mgmtTp)">
							 <if test="@MybatisUtils@equalsByString(mgmtTp, 'RLC')">
							 AND b.rlc_id= #{rlcId}
							 </if>
							 <if test="@MybatisUtils@equalsByString(mgmtTp, 'DLC')">
							 AND b.dlc_id= #{dlcId}
							 </if>
							 AND mgmtc_tp = #{mgmtTp}
						 </if>
						 <if test="@MybatisUtils@isEmpty(mgmtTp)">
							<if test="@MybatisUtils@isNotEmpty(rlcId)">
							AND b.rlc_id= #{rlcId}
							</if>
							<if test="@MybatisUtils@isNotEmpty(dlcId)">
							AND b.dlc_id= #{dlcId}
						 	</if>
						 </if>
						<!-- AND b.join_state_cd <![CDATA[<>]]> 'LEAVE_SUCC' -->
						AND  b.join_state_cd in ('JOIN_SUCC', 'LEAVE_RES')
					  )
		ORDER BY a.user_nm ASC
	</select>
	
	<select id="selectCustomUserListOfRlc" parameterType="com.skt.mate.model.domain.user.CustomUserVO" resultMap="CustomUserMap">
		SELECT /* [user/userInfo.sqlmap.xml].[selectCustomUserListOfRlc] by hwkim */
			   a.user_id
			 , a.user_nm
		  FROM system_user a
		 WHERE EXISTS (
						SELECT '1'
						  FROM custom b
						 WHERE b.user_id = a.user_id
						 <if test="@MybatisUtils@isNotEmpty(customUserId)">
						   AND b.user_id = #{customUserId}
						 </if>
						 <if test="@MybatisUtils@isNotEmpty(mgmtTp)">
							 <if test="@MybatisUtils@equalsByString(mgmtTp, 'RLC')">
							 	<if test="@MybatisUtils@isNotEmpty(rlcId)">
								AND b.rlc_id= #{rlcId}
								</if>
								<if test="@MybatisUtils@isNotEmpty(dlcId)">
								AND b.dlc_id= #{dlcId}
							 	</if>
							 </if>
							 <if test="@MybatisUtils@equalsByString(mgmtTp, 'DLC')">
							 AND b.dlc_id= #{dlcId}
							 </if>
							 <!-- AND mgmtc_tp = #{mgmtTp} -->
							 AND mgmtc_tp = 'DLC'
						 </if>
						 <if test="@MybatisUtils@isEmpty(mgmtTp)">
							<if test="@MybatisUtils@isNotEmpty(rlcId)">
							AND b.rlc_id= #{rlcId}
							</if>
							<if test="@MybatisUtils@isNotEmpty(dlcId)">
							AND b.dlc_id= #{dlcId}
						 	</if>
						 </if>
						<!-- AND b.join_state_cd <![CDATA[<>]]> 'LEAVE_SUCC' -->
						AND  b.join_state_cd in ('JOIN_SUCC', 'LEAVE_RES')
					  )
		ORDER BY a.user_nm ASC
	</select>

	<select id="selectCustomUserAndRlcList" parameterType="com.skt.mate.model.domain.user.CustomUserVO" resultMap="CustomUserMap">
		SELECT /* [user/userInfo.sqlmap.xml].[selectCustomUserAndRlcList] by hwkim */
		a.user_id
		, a.user_nm
		, (SELECT r.rlc_disp_nm FROM rlc r WHERE r.rlc_id=b.rlc_id) as rlc_nm
		, (SELECT d.dlc_disp_nm FROM dlc d WHERE d.dlc_id=b.dlc_id) as dlc_nm
		FROM system_user a, custom b
		WHERE b.user_id = a.user_id
		<if test="@MybatisUtils@isNotEmpty(customUserId)">
			AND b.user_id = #{customUserId}
		</if>
		<if test="@MybatisUtils@isNotEmpty(blcId)">
			AND b.blc_id= #{blcId}
		</if>
		<if test="@MybatisUtils@isNotEmpty(rlcId)">
			AND b.rlc_id= #{rlcId}
		</if>
		<!-- AND b.join_state_cd <![CDATA[<>]]> 'LEAVE_SUCC' -->
		AND  b.join_state_cd in ('JOIN_SUCC', 'LEAVE_RES')
		ORDER BY a.user_nm ASC
	</select>
	<resultMap id="OpenApiUserMap" type="com.skt.mate.model.domain.openapi.OpenApiUserVO">
		<id property="userId" column="USER_ID"/>
		<id property="userNm" column="USER_NM"/>
		<result property="encryKey" column="ENCRY_KEY"/>
		<collection property="ipList" javaType="java.util.List" resultMap="openApiUserIpListMap"/>
		<collection property="rsrcList" javaType="java.util.List" resultMap="openApiUserRsrcListMap"/>
	</resultMap>
	
	<resultMap id="openApiUserIpListMap" type="com.skt.mate.model.domain.user.CrmClientVO">
		<result property="ip" column="IP"/>
	</resultMap>
	
	<resultMap id="openApiUserRsrcListMap" type="com.skt.mate.model.domain.user.Resource">
		<result property="rsrcUrl" column="RSRC_URL"/>
		<result property="prgmId" column="PRGM_ID"/>
		<result property="useYn" column="USE_YN"/>
	</resultMap>	
	
	<!--
		Open API 용 사용자 정보 조회 
	 -->
	<select id="selectOpenApiUserInfo" parameterType="com.skt.mate.model.domain.user.CustomUserVO" resultMap="OpenApiUserMap">
		SELECT /*[user/userInfo.sqlmap.xml].[selectOpenApiUserInfo] by shsin*/ 
		     /*+ LEADING(x) USE_NL(z) */
		     x.USER_ID
		    ,y.USER_NM
		    ,x.ENCRY_KEY
		    ,y.RSRC_URL
		    ,y.PRGM_ID
		    ,y.USE_YN
		    ,z.IP
		FROM CUSTOM x, CRM_CLIENT z,
		(
		  SELECT /*+ ORDERED USE_NL(b,c,d,e) */ a.USER_ID, a.USER_NM, e.*
		  FROM SYSTEM_USER a, USER_ROLE_MAPP b, ROLE c, ROLE_RSRC_MAPP d, RSRC e
		  WHERE a.USER_TP_CD = 'API'
		  AND c.ROLE_TP_CD = 'API'
		  AND c.USE_YN = 'Y'
		  AND e.RSRC_TP_CD = 'F'
		  AND e.DOMAIN_TP_CD = 'API'
		  AND a.USER_ID = b.USER_ID
		  AND b.ROLE_ID = c.ROLE_ID
		  AND c.ROLE_ID = d.ROLE_ID
		  AND d.RSRC_ID = e.RSRC_ID
		) y
		WHERE x.USER_ID =   y.USER_ID(+)
		AND x.USER_ID =   z.USER_ID(+)
		AND x.ACCESS_KEY = #{accessKey}
		AND x.USE_YN = 'Y'
		/* AND x.STATE_CD = '' 사용자 상태 */
	</select>	
	
	<update id="updateSystemUser" parameterType="com.skt.mate.model.domain.user.UserVO">
		UPDATE SYSTEM_USER
		SET
			upd_dttm = sysdate
			, upd_user_id = #{updUserId}
			, upd_prgm_id = #{updPrgmId}
			<if test="@MybatisUtils@isNotEmpty(userNm)">
			, USER_NM = #{userNm}
			</if>
		<where>
		USER_ID = #{userId}
		</where>
	</update>
	
	<insert id="insertSystemUser" parameterType="com.skt.mate.model.domain.user.UserVO">
		<selectKey keyProperty="userId" resultType="int" order="BEFORE">
    		select user_id_seq.NEXTVAL FROM DUAL
  		</selectKey>
		INSERT INTO SYSTEM_USER (
			USER_ID
			, USER_TP_CD
			, USER_NM
			, crt_dttm
			, crt_user_id
			, crt_prgm_id
			, upd_dttm
			, upd_user_id
			, upd_prgm_id
			<if test="@MybatisUtils@isNotEmpty(userDesc)">
			, user_descr
			</if>
		) VALUES (
			 #{userId}
			, #{userTpCd}
			, #{userNm}
			, sysdate
			, #{crtUserId}
			, #{crtPrgmId}
			, sysdate
			, #{updUserId}
			, #{updPrgmId}
			<if test="@MybatisUtils@isNotEmpty(userDesc)">
			, #{userDesc}
			</if>
		)
	</insert>
	
	<delete id="deleteSystemUser" parameterType="com.skt.mate.model.domain.user.UserVO">
		DELETE
		FROM		SYSTEM_USER
		<where>			
			AND		user_id = #{userId}
		</where>
	</delete>

    <resultMap id="DealerUserMap" type="com.skt.mate.model.domain.user.DealerUserVO" extends="common.CommonMap">
        <result property="dlcId" 				column="dlc_id"		/>
        <result property="rlcId" 				column="rlc_id"		/>
        <result property="dlcNm"				column="dlc_nm"		/>
        <result property="dlcDPNm"				column="dlc_disp_nm"/>
    </resultMap>
    
    <select id="selectDealerListByRlcId" parameterType="Integer" resultMap="DealerUserMap">
        SELECT
        DLC_ID
        , DLC_NM
        , DLC_DISP_NM
        FROM DLC
        WHERE 1=1
        <if test="@MybatisUtils@isNotEmpty(rlcId)">
            AND RLC_ID = #{rlcId}
        </if>
		<if test="@MybatisUtils@isEmpty(rlcId)">
			AND RLC_ID = NULL
		</if>
    </select>
	<select id="selectDealerList" parameterType="com.skt.mate.model.domain.user.CustomUserVO" resultMap="DealerUserMap">
		SELECT
		DLC_ID
		, DLC_NM
		, DLC_DISP_NM
		FROM DLC
		WHERE 1=1
		<if test="@MybatisUtils@isNotEmpty(rlcId)">
			AND RLC_ID = #{rlcId}
		</if>
	</select>
	
	<!-- 고객사 관리자가 포함된 사업자 코드 -->
	<select id="selectCustomBlcCdByUserId" parameterType="Integer" resultType="String">
		SELECT
		    d.BLC_CD
		FROM SYSTEM_USER a
		INNER JOIN CUSTOM_CONTACT b ON a.USER_ID = b.USER_ID
		INNER JOIN CUSTOM c ON b.CUSTOM_ID = c.USER_ID
		INNER JOIN BLC d ON d.BLC_ID = c.BLC_ID
		WHERE c.USER_ID = #{userId}
	</select>
	
	<!-- 사업ID -->
	<select id="selectBlcIdByCode" parameterType="String" resultType="Integer">
		SELECT BLC_ID
		FROM BLC
		WHERE blc_cd = #{blcCd}
	</select>
</mapper>