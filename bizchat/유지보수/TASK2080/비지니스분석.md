# 비지니스 분석
## Spring Initializer
WebApplicationInitializer
    -> AbstractContextLoaderInitializer
        -> AbstractDispatcherServletInitializer
            -> AbstractAnnotationConfigDispatcherServletInitializer
                => WebApplicationConfig => 시작

## Spring 초기실행
WebApplicationConfig
    => config
        -> SpringRootConfig
        -> SpringAdminDataSourceConfig
        -> SpringCacheConfig
        -> SpringSecurityConfig => 권한관련로직
        -> SpringAdminConfig
        -> SpringMvcConfig
    => 필터
        -> CharacterEncodingFilter
        -> DelegatingFilterProxy
        -> SiteMeshFilter
        -> XSSServletFilter
        -> RequestContextFilter

# Admin 화면 분석
★ 비지니서 로그인 유저정보 취득 방법
AdminUserVO adminUser = (AdminUserVO)SecurityContextHolder.getContext().getAuthentication().getDetails();

## Admin 로그인
[UsernameAuthenticationProvider::authenticate]
-> AdminInfoService::loadUserByUsername
    -> ::findAdminUser
        -> AdminInfoMapper::selectAdminUser(adminInfo.sqlmap.xml)
            -> DB: 사용자 조회 => ★★ SELECT(SYSTEM_USER/ADMIN/USER_ROLE_MAPP/ROLE) => BLC_ID 조회추가

## 콤보박스 중계사
surveyHistList.jsp (wl:CodeList 태그를 이용한 쿼리 조회값을 세팅)
[RequestContextAwareTag::doStartTag]
-> CodeListTag::doStartTagInternal
    -> CommonCodeService::searchCodeList
        -> CodeMapper::selectCodeList(code.sqlmap.xml)
            -> DB: 중계사 조회 => ★★ SELECT(COM_CD) => BLC_ID 조회추가

## Web 인증처리
SpringSecurityConfig
    -> AnonymousAuthenticationFilter::doFilter
        -> CustomerContactService::searchRoleResourceList
            -> RoleMapper::selectRoleResourceList
                DB: 아이디 권한이 가진 메뉴정보 취득 => SELECT(RSRC, ROLE_RSRC_MAPP)

SpringSecurityConfig::filterSecurityInterceptor
    -> DaoFilterInvocationSecurityMetadataSource::getAttributes
        -> AdminInfoService::loadGrantedAuthorityByUrl
            -> RoleMapper::selectRoleByRsrcUrl

## Admin화면 메뉴 접근 => topMenu.jsp ★★ OBIZ인경우를 판단하도록 한다.
LoginSuccessHandler::onAuthenticationSuccess
    -> ★★ 오비즈 판단하도록 하였다. (session )
    -> AdminInfoService::selectRoleResourceList

## 관리자등록
=> 여기서 어떤 테이블을 사용하는지 조사
UserController::create  => adminCreate.jsp
    -> AdminInfoService::selectRoleList
        -> AdminInfoMapper::selectAdminRoleList
            -> DB: 롤 조회 -> SELECT(ROLE/RLC/DLC)

## 운영관리
1. ★ Admin > 운영관리 > 공지사항 관리 > 조회
NotiController::list
    -> NotiService::searchNotiList
        -> NotiMapper::selectNotiPageList(noti.sqlmap.xml/selectNotiPageList)
            -> DB: 공지사항 조회 -> SELECT(NOTI) ★★ NOTI테이블::BLC_ID 추가 및 로직/쿼리 수정 (blc를 조회조건 추가)

2. ★ Admin > 운영관리 > 공지사항 관리 > 등록/수정
NotiController::registSave
    -> NotiService::createNoti
        -> NotiMapper::insertNoti(noti.sqlmap.xml)
            -> DB: 공지사항 등록 -> INSERT(NOTI) ★★ NOTI테이블::BLC_ID컬럼 추가 로직/쿼리 수정
    -> NotiService::modifyNoti
        -> NotiMapper::updateNoti(noti.sqlmap.xml)
            -> DB: 공지사항 수정 -> UPDATE(NOTI) ★★ NOTI테이블::BLC_ID컬럼 추가 로직/쿼리 수정

3. ★ Admin > 운영관리 > FAQ 관리 > 조회
FaqController::list
    -> FaqService::searchFaqList
        -> FaqMapper::selectFaqPageList(faq.sqlmap.xml/selectFaqPageList)
            -> DB: FAQ조회 -> SELECT(FAQ)  ★★ FAQ테이블::BLC_ID 추가 및 로직/쿼리 수정 (blc를 조회조건 추가)

4. ★ Admin > 운영관리 > FAQ 관리 > 등록/수정
FaqController::registSave
    -> FaqService::insertFaq
        -> FaqMapper::insertFaq(faq.sqlmap.xml/insertFaq)
            -> DB: 공지사항 등록 -> INSERT(FAQ) ★★ FAQ테이블::BLC_ID컬럼 추가 로직/쿼리 수정
    -> FaqService::updateFaq
        -> FaqMapper::updateFaq(faq.sqlmap.xml/updateFaq)
            -> DB: 공지사항 등록 -> UPDATE(FAQ)

5. ★ Admin > 운영관리 > 1:1 관리 > 조회
QnaController::list
    -> QnaService::searchQnaList
        -> QnaMapper::selectQnaPageList(qna.sqlmap.xml/selectQnaPageList)
            -> DB: 1:1문의 조회 -> SELECT(QNA) ★★ QNA테이블::BLC_ID 추가 및 로직/쿼리 수정 (blc를 조회조건 추가)

## 1:1
topMenu.jsp

## 관리자 관리
1. Admin > 관리자 관리 > 관리자 조회
UserController::list => ★★ adminList.jsp => mgmtpcd:BLC 인경우 처리
    -> AdminInfoService::searchAdminUserPageList
        -> AdminInfoMapper::selectAdminUserPageList(adminInfo.sqlmap.xml)
            -> ★★ DB: 관리자 조회 => SELECT(SYSTEM_USER/ADMIN/USER_ROLE_MAPP/BLC/RLC/DLC) => BLC인경우 추가

2. Admin > 관리자 관리 > 관리자 등록 화면
UserController::create => adminCreate.jsp
    -> AdminInfoService::selectRoleList
        -> AdminInfoMapper::selectAdminRoleList(adminInfo.sqlmap.xml)
            -> DB: 모든 롤 정보 
3. Admin > 관리자 관리 > 관리자 수정/등록
UserController::save(adminInfo.sqlmap.xml)
    => 수정이면
        -> ★ AdminInfoService::modifyAdminUser => Admin권한 수정
    => 등록이면
        -> AdminInfoService::createAdminUser => Admin권한 수정
            -> ::selectRlcIdByCode
                -> AdminInfoMapper::selectRlcIdByCode
            -> AdminInfoMapper::selectRlcInfoByRlcCode
            -> AdminInfoMapper::selectDlcInfoByDlcCode
            -> UserInfoMapper::insertSystemUser
                -> DB: 시스템 사용자 추가 => INSERT(system_user)
            -> AdminInfoMapper::insertAdmin
                -> DB: 어드민 사용자 추가 => INSERT(admin)
            -> RoleMapper::selectRoleByTpCd
                -> DB: 롤 조회 => SELECT(role) => ★ BLC용 role을 추가 여부 판단
            -> RoleMapper::insertUserRoleMapp
                -> DB: 사용자 역할 매핑 저장 => INSERT(USER_ROLE_MAPP)

## 고객사 관리(Web사용자 관리/승인/반려 처리)
1. 조회
CustomerController::list
    -> CustomerService::searchCustomerManagePageList
        -> CustomerManageMapper::selectCustomerManagePageList (customerManage.sqlmap.xml)
            -> DB: 고객사 조회 => SELECT(system_user/custom)

2. 조회 > 상세정보 > 표시
CustomerController::detail => customerDetail.jsp => ★ 여기서 BLC/RLC/DLC 아이디가 넘어와야 할듯한데 안넘어온다. 그렇다면 CUSTOM테이블에 수동으로 입력하는가???
    -> CustomerService::searchCustomer
        -> CustomerManageMapper::selectCustomerDetail(customerManage.sqlmap.xml)
            -> DB: 고객 조회 => SELECT(CUSTOM) => ★★ BLC_ID도 넘기도록 한다.
    -> CustomerService::searchCustomerContactList

3. 조회 > 상세정보 > [승인/반려]
CustomerController::saveJoinState
    -> CustomerService::saveJoinState
        -> CustomerContactMapper::updateCustomerContcatInfo(customerContact.sqlmap.xml)
            -> DB: 고객 담당자 갱신 => UPDATE(CUSTOM_CONTACT)
        -> CustomerManageMapper::updateCustomerCustom(customerManage.sqlmap.xml)
            -> DB: 고객 갱신 => ★ UPDATE(CUSTOM) => BLC_ID 추가여부 판단
        -> CustomerManageMapper::selectCustomStateUpdHist
        -> CustomerManageMapper::insertCustomStateUpdHist
        -> CustomerManageMapper::insertCustomSndLimit
        -> CustomerManageMapper::selectCustomerContactMainUserInfo
            -> DB: 고객 담당자 조회 => SELECT(CUSTOM_CONTACT)
        -> ★ BLC_ID가지고 OBIZ용도이면 RoleId도 오비즈용도로 처리하게 한다.
        -> RoleMapper::insertUserRoleMapp(role.sqlmap.xml)
            -> DB: 사용자 역할 매핑 저장 => INSERT(USER_ROLE_MAPP)

## 서비스 관리 > 상품 관리
1. 체험 상품 관리
ChargeMgmtController::freeChargeUsingList
-> 
# 특번(발신번호)
## AsIS 특번(발신번호) 관리
1. 특번관리 > /chargeSpc/customSpcNumMgmt => customSpcNumMgmt.jsp
2. 특번관리 > 특번신청 > /chargeSpc/addSpcNum
ChargeAndSpcNumController::addSpcNum => spcNumRegist.jsp
    -> 
3. 특번관리 > 특번신청 > 특번유효 판단 > /chargeSpc/checkSpcNum
4. 특번관리 > 특번신청 > 신청 저장 > /chargeSpc/saveSpcNum

## ToBe 발신번호 관리
1. 서비스 관리 > 특번 관리 (spcNumReqList.jsp)
SpcNumNumMgmtController::spcNumReqList
    => 고객사 조회
        -> MateService::searchCustomUserPageList
    -> SpcNumNumMgmtService::searchSpcNumReqPageList
        -> CustomSpcNumMapper::selectCustomSpcNumPageList
            -> DB: 특번 조회 => SELECT(custom_spc_num/custom_spc_num_svc/custom) => ★★ BLC_ID 추가

2. 서비스 관리 > 특번 조회
SpcNumNumMgmtController::spcNumList
    => 고객사 조회
        -> MateService::searchCustomUserPageList
            -> UserInfoMapper::selectCustomUserList
                -> DB: 고객사 조회 => SELECT(CUSTOM) => ★★ BLC_ID 추가
        -> SpcNumNumMgmtService::searchSpcNumReqPageList
            -> CustomSpcNumMapper::selectCustomSpcNumPageList
                -> DB: 특번 조회 => SELECT(custom_spc_num/custom_spc_num_svc/custom) => ★★ BLC_ID 추가

2. 서비스 관리 > 특번 등록
SpcNumNumMgmtController::registSpcNum
    -> MateService::selectCustomUserAndRlcList
        -> UserInfoMapper::selectCustomUserAndRlcList
            -> DB: 고객사 조회 => SELECT(system_user/custom) => ★★ BLC_ID 추가


## 특번신청(발신번호 신청)
1. 발신번호 신청 화면 (spcNumRegist.jsp)
URL: /chargeSpc/addSpcNum (rsrc: 592)
ChargeAndSpcNumController::addSpcNum

2. 특번 신청 로직
URL: /chargeSpc/saveSpcNum (rsrc: 593)
ChargeAndSpcNumController::saveSpcNum
    -> ChargeAndSpcNumService::createCustomSpcNum
        -> CodeMapper::selectCodeListByCdGrpId
        -> CustomSpcNumMapper::insertCustomSpcNum
        -> CustomSvcUpdHistMapper::insertCustomSvcUpdHist
        -> CustomSvcUpdHistValMapper::insertCustomSvcUpdHistVal
        -> CustomSpcNumMapper::insertCustomSpcNumSvc
        -> CustomSvcUpdHistValMapper::insertCustomSvcUpdHistVal
        -> ::saveMail

        -> customSpcNum.sqlmap.xml/insertCustomSpcNum/insertCustomSpcNumSvc

## 공통
1. 메지시 관리 & 통계 > MO메시지 조회 (moRcvHistList.jsp)
MateController::moList
moRcvHistList

## 휴면계정 처리 방식
1. 배치기동
user:mateserver
path:/app/mateserver
scheduler: crontab -l
- 배치처리
batch.job.accountSeparateJob.xml::accountSeparateJob
    -> AccountSeparateWriter::write
        => 운영자계정 처리
            -> AccountSeparateService::saveAccountSeparate
        => 고객계정 처리
            -> AccountSeparateService::saveCustomerSeparate

2. 고객사관리 > 휴면계정관리
InactiveCustomerController::list
    -> 

# Web화면 분석

## 고객센터
1. FAQ

2. 공지사항

3. 1:1문의

## 회원가입(WEB사용자 추가)
주요테이블: system_user / custom_contact / custom
1. 사업자등록번호 확인
UserController::joinOneStep => joinOneStep.jsp
UserController::memberCheck
    -> UserService::searchMember
        -> CustomerManageMapper::selectCustomerInfo (customerManage.sqlmap.xml)
            -> DB: 사업자등록번호 조회 -> SELECT(custom)
2. 회사정보 등록 화면
UserController::joinTrdStep => joinTrdStep.jsp
3. 회사정보 등록 저장 (참고: ContactType: CHR(신규가입?) / ASS(탈퇴?))
UserController::saveTrdStep
    -> UserService::createMemberInfo
        => 조건(ContactType:CHR)
            -> UserInfoMapper::insertSystemUser(userInfo.sqlmap.xml)
                -> DB: 시스템 유저 추가 => INSERT(system_user)
            -> CustomerManageMapper::insertCustomer
                -> DB: 고객 추가 => INSERT(custom) (system_user:custom_id = custom:user_id)
        => 조건(아니면 ContactTp: CHR조회)
            -> CustomerContactMapper::selectCustomerContactMainUserInfoByBizReNum
                -> DB: 고객 조회 => SELECT(custom_contact/custom)
        ↓↓↓ ★★ 여기서 시스템 유저 등록을 실제로 한다.
        -> UserInfoMapper::insertSystemUser (userInfo.sqlmap.xml)
            -> DB: 담당자 시스템 유저 등록 => INSERT(system_user)
        -> UserService::insertCustomerContact (customerContact.sqlmap.xml)
            -> DB: 고객 담당자 유저 등록 => INSERT(custom_contact)
        ↑↑↑ ★★ 여기서 시스템 유저 등록을 실제로 한다.
        -> ... 비밀번호 이력 추가
        -> ... 약관동의 정보 저장
3-1. 이메일 체크
uri:/user/join/checkDupleData


## Web로그인
1. 인증처리
SpringSecurityConfig::(순서: authenticate -> filter)
      => authenticationProvider
         -> UsernameAuthenticationProvider::authenticate 
            -> CustomerContactService::loadUserByUsername
                -> ::findCustomerContcat
                    -> CustomerContactMapper::selectCustomerContactInfo(customerContact.sqlmap.xml)
                        -> DB: 로그인 유저 조회 => SELECT(SYSTEM_USER/CUSTOM_CONTACT/USER_ROLE_MAPP/ROLE)
               => 성공 
                  -> SecurityContextHolder.getContext.setAuthentication
               => 실패
                  -> 각 로그인 실패별 예외처리 throw ①
                  -> CustomerContactService::modifyLoginFail (실패 카운트)
      => UsernamePasswordAuthenticationFilter
         => 성공
            -> LoginSuccessHandler
         => 실패
            -> onAuthenticationFailure
               -> ① 로그인 실패 예외를 받아서 session에 저장


CustomerService::createCustomInfo

CustomerController::saveJoinState
    -> CustomerService::saveJoinState

insertUserRoleMapp(role.sqlmap.xml)
insertUserRoleMapp

# 별도 분석중
createAdminUser
(adminInfo.sqlmap.xml)


## Role
- [] 아래 코드는 무엇인가?
* role_tp_cd
    - API
    - SUA
    - ADM
    - STM
    - OPR
    - DEV
    - CUAD
    - CANONY
    - CUOP
    - CUDF
    - CUJR
    - API
    - CUOP
    - RLC
    - DLC
