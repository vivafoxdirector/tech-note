# 비지니스 분석
MMS설문등록 부터 승인 발송까지 분석한다. 분석내용은 20201028.md 파일 기준으로 추가 내용을 기술한다.

1. 설문 전체 라이프사이클 상태
등록 -> STAT:REGIST -> 승인 -> STAT:APPR -> 스케쥴:10분 -> STAT:RUNNING -> 스케쥴:3분 -> MSG_STAT:WAIT -> MQ:PUSH

# 비즈챗 Web 분석

## 이전설문불러오기
화면: 이전설문불러오기->리스트선택->불러오기
SurveyController::beforeSurveyPupUp
   -> ProjectMgmtService::searchProjectList -> ProjectMapper::selectProjectList
      -> DB: 프로젝트 리스트

   -> 리스트선택 
      -> SurveyController::beforeSurvey -> ProjectMapper::getBeforeSurvey

## 설문등록(화면: 설문제작)
/survey/surveyRegist -> surveyRegist.jsp
SurveyController::registSurvey => surveyRegist.jsp 
   -> 화면표시
      -> SurveyController::registSurvey      
         -> ChargeAndSpcNumService::searchCustomChargeBuyList -> DB: 요금제 구매 리스트 조회 -> SELECT(CHARGE_SVC)
         -> SurveyMgmtService::isUseTargetYn -> DB: 중계사 조회 -> SELECT(RLC)
         -> ChargeAndSpcNumService::getCustomSpcNumTotalCnt -> DB: 특번 카운트 조회 -> SELECT(custom_spc_num/custom_spc_num_svc/custom)
         -> ChargeAndSpcNumService::searchCustomSpcNumList -> DB: 특번 리스트 조회 -> SELECT(custom_spc_num/custom_spc_num_svc/custom)
         -> ProjectMgmtService::searchProjectList -> DB: 프로젝트 리스트 조회 -> SELECT(SURVEY_PROJECT/SURVEY/SYSTEM_USER)
         -> RETURN(VO: SurveyProjectVO)
   -> 등록
      -> SurveyController::saveSurvey(VO:ServeyVO)
         -> ChargeAndSpcNumService::searchCustomChargeBuyList -> DB: 요금제 구매 리스트 조회 -> SELECT(CHARGE_SVC)            
         -> ProjectMgmtService::selectProject(VO:SurveyProjectVO) -> DB: 프로젝트 조회 -> SELECT(SURVEY_PROJECT/SURVEY/SYSTEM_USER)
         -> ★ 첨부 이미지처리(복수 이미지) -> 이미지 검증(Tika라이브러리/확장자 검증등) 
            -> ★ SurveyMgmtService::saveSurvey(SurveyVO/CustomerContactVO) -> DB: 설문 등록 ->    <== 이것을 RCS용도로 별도로 작성을 하는 방법 생각
               -> SurveyMapper::deleteSurveyTarget -> DB: 기존 데이터 삭제 -> DELETE(SURVEY_TRGTER)
               -> SurveyMapper::deleteSurveyRjtTarget -> DB: 기존 데이터 삭제 -> DELETE(SURVEY_RCV_RJTER)           
               -> ★ ::surveyFileUpload -> FileUtil.transferTo -> FILE: 이미지 업로드
               -> 상태
                  -> SurveyCode.SurveyStateCd.TEMP_SAVE (임시저장)
                  -> SurveyCode.SurveyStateCd.REGISTER (등록요청)
                     -> ★ SurveyMapper::insertSurvey -> DB: 설문 저장 -> INSERT(SURVEY)
                     -> ::saveMail -> 관리자 문자 알림
               -> 루프처리
                  -> ★ ::qustImgUpload(설문이미지들) -> FileUtil.transferTo -> FILE: 업로드
                  -> ★ SurveyMapper::insertSurveyQuestion() -> DB:설문질문 이미지/쿠폰 등록 -> INSERT(SURVEY_QUST)
            -> 성공/실패
               -> resultMap(surveySeq/resultMessage/resCd)               

설문조회
selectSurvey

화면: 설문관리
surveyList.jsp
SurveyController::getSurveyList

# 비즈챗 Admin 분석
## 설문승인(화면: 관리자->설문승인)
### 화면동작
uri:survey/reqlist -> 화면: 설문승인 -> surveyReqList.jsp -> 설문상태: REGISTER
   -> [승인]
      -> 타게팅이 있을때 처리
      -> 타게팅 없을때 처리
         -> /survey/updateState -> 설문상태: APPR

   -> [반려]

### 소스동작 (ADMIN)
화면: 설문 리스트 -> 설문승인 동작
SurveyController::getSurveyReqlist
   -> SurveyMgmtService::searchSurveyRequestList -> DB: 설문승인 예정 조회 -> SELECT(SURVEY/SYSTEM_USER/CUSTOM/SURVEY_PROJECT)

SurveyController::updateState
   -> SurveyMgmtService::updateTargetingSurvey 
      -> 받는 폰넘버 파일 잇으면 
         -> SurveyCode.SurveyStateCd.APPR -> 설문상태: APPR
            -> DB: deleteSurveyTarget, moveSurveyTarget, updateSurveyForTarget, insertSurveyStateHistory
      -> 받는 폰넘버 파일 없으면
         -> DB: updateSurveyState, insertSurveyStateHistory
      -> SurveyMgmtService::saveMail

# 스케쥴러 분석(mmate-survey-agent)
## 초기실행
BootStrap::start ->
   SenderApplicationConfig
      -> BEAN: MessageSource
      -> BEAN: ThreadPoolTaskScheduler
      -> ★ BEAN: SchedulerSendMsgSearchTask
      -> BEAN: SchedulerMoveTask

### 10분 (설문상태: APPR -> RUNNING 처리)

SchedulerStartSurveyTask::startSurvey
   -> SurveyMapper::selectSurveyForScheduler -> 설문상태: APPR -> DB: 설문상태(APPR) 조회 -> SELECT(SURVEY)
      -> 루프처리(APPR리스트)
         -> ::startSurvey(SurveySeq별로 루프)
            -> 설문 정보
               -> SurveyMapper::selectSurvey -> DB: 설문조회 -> SELECT(SURVEY)
            -> 동시간대 진행중인 설문중 중복 MDN 처리
               -> SurveyMapper::updateSurveyDupTrgter -> 설문상태: RUNNING -> DB: 설문상태 갱신 -> UPDATE(SURVEY_TRGTER/) 
            -> 발송대상자
               -> SurveyMapper::selectSurveyTrgter -> DB: 대상자 조회 -> SELECT(SURVEY_TRGTER)
            -> 고객특번확인
               -> getCustomSpcNumList
            -> 비즈챗 사용확인
               -> getCustomSvcList
            -> ★ 루프처리
               -> ★ 이미지PATH 없음(SurveyVO::SurveyAgreImgFilePath => 코폰이미지)
                  -> SMS/LMS 처리
               -> ★ 이미지PATH 있음
                  -> MMS 처리
            -> ★ SenderService::createSndMsgBatch 
               -> SenderMapper::insertSndMsgBatch -> DB: 메시지 저장 -> INSERT(SND_MSG(SURVEY_SEQ포함)=> MSG_TP (SMS/LMS/MMS)) => ★RCS용도로 SND_MSG에 관련내용을 포함할 것인가...고민
            -> ★ SenderService::createSndAttrFileBatch (첨부이미지 저장처리)
               -> SenderMapper::insertSndAttrFileBatch -> DB: 이미지정보 저장 -> INSERT(SND_ATTFILE)
         -> 상태: RUNNING
         -> 상태: ERROR
         -> updateSurveyStateCd -> DB: 설문상태 RUNNING/ERROR 갱신 -> UPDATE(SURVEY)
   
### 3분 (RUNNING -> MQ:REQUEST:PUSH)
★ SchedulerSendMsgSearchTask
   -> ::sendLms
   -> ::sendSms
   -> ★ ::sendMms
      -> SurveyService::getSurveyByStateAndDate
         -> DB: 설문 RUNNING 상태 조회 -> SELECT(SURVEY)
      -> SenderService::searchListSendMsgForMms
         -> DB: 메시지 내용 조회 -> SELECT(SND_MSG) -> SND_MSG 에서 MMS이고, SURVEY_SEQ인 리스트 취득
      -> MtMessageService::saveSendMessage
         -> ★ 많은일을 한다.
         -> MtMsgQueueVO(CustomReqId=SndMsg:MSG_SEQ 포함)
         -> ::createMtMsgQueue(MtSndReqVO, MtMsgQueueVO, MtMsgQueueBinVO)
            -> DB: 정보입력 -> INSERT(MT_SND_REQ)
            -> DB: 정보입력 -> INSERT(★ MT_MSG_QUEUE)
            -> DB: 이미지 정보입력 -> INSERT(MT_MSG_QUEUE_BIN)
         -> ★ MessageQueueSender::sendMtMgrRequest(MtMessage) -> MessageStatus.WAIT -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH

### 수신부분 ...ing
SurveyService::sendAnsErrNotiMsg
SurveyService::sendSurveyCoupon -> sendMsg
ReceiveMsgHandler::sendSurvey -> SurveyService::sendSurveyCoupon
ReceiveMsgHandler::sendSurvey -> SurveyService::sendSurveyQuestion
   -> createSndMsg ->insertSndMsg -> DB: 메시지 저장 -> INSERT(SND_MSG)

# MQ매니저 mmate-mt-mgr 분석
MSG_REQUEST 
9. MMS 전송 결과 MQ Push
MtMgrRequestQueueListener::onMessage 
   -> MtMgrService::searchMtMsgQueueInfo
      -> DB: 조회 -> SELECT(MT_MSG_QUEUE[userid, mtqueueid])
   -> DeviceCacheService::findDeviceInfo
      -> CACHE: 조회 -> JPA(device)
   -> MtMgrService::modifyMtMsgQueue -> MessageStatus.REQ or FAIL -> QUEUE상태 갱신
      -> DB: 갱신 -> UPDATE(MT_MSG_QUEUE)
   -> 성공여부 
      -> 실패 -> MtMgrService::sendMtMgrReultByFinalFail
                  -> MtMgrResultSenderByFinalFail::sendMtMgrResult -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
      -> 성공
         -> SKT아닌경우(AGENT를 통해 발송)
            -> RlcAgentService::saveInfoBackMtMessage
         -> SKT경우
            -> MtMgrService::sendMsgReq (메시지별 직접 통신사 송신)
               -> SMS:MtSmsSender::sendMtSmsSktRequest -> MQ:PUSH
               -> LMS:MtMmsSender::sendMtMmsSktRequest -> MQ:PUSH
               -> MMS:MtMmsSender::sendMtMmsSktRequest -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH

# mms client
MmsSktClient::toSubmit -> SktDeliverySubmit -> 최종 딜리버리용 객체를 만든다.이것을 이용하여 RCS도 이용하도록 한다.

..ing

@@@#@#@#@#
MtMsgQueueVO 클래스와 MtMsgQueueVO용도의 DB스키마를 RCS용을 추가하면 어떨까 싶다.

* MMS같은 경우 MtMsgQueue를 MtMsgQueueInfo에 파일과 컨텐츠를 담아서 클라이언트에 전송을 한다.
MmsSendManager::sendMessage ->  MmsSktClient::sendMessage(MtMsgQueueInfo)
* RCS라면 위와 비슷하게 처리하도록 고민해보자..


9-1. SKT MMS Client (메시지 복호화 처리 -> 파일정보 -> 발송 큐에 적재)
MmsSktQueueListener::onMessage -> QueueName.MT_MMS.MT_MMS_SKT -> ::findMtMsgQueue -> MmsMtMessageService::findMtMessageQueue -> 메시지 복호화 처리
                                                                                        -> DB : 조회 -> SELECT(MT_MSG_QUEUE[mtqueueid])
                               -> RclID 없다면
                                  -> CustomerService::findCustomerDetail -> DB: RclID 조회 -> 존재여부 -> 실패 -> 예외
                               -> RclID 있다면 (단말기 발송처리!!!!)
                                  -> MmsSendManager::sendMessage -> MmsMtMessageService::searchMtMessageQueueFileList
                                                                      -> MmsMtMessageService::selectMtMsgQueueBinList
                                                                        -> DB: 단말기 MMS 첨부파일 조회 -> SELECT(MT_MSG_QUEUE_BIN)
                                                                      -> MmsSktClient::sendMessage -> queue:put
9-2. SKT MMS Client (발송 큐에서 메시지 취득후 발송후 단말로 부터 Submit RES 메시지 받는다. (발송에 대한 결과값이 반환이 아니다.))
MmsSktClient::run -> 연결이 끊어져있다면
                    -> Queue의 모든 메시지 -> MessageStatus.RETRY -> MmsSktQueueSender::sendMtMgrRequest
                  -> 연결되어 있다면
                    -> ::queue::poll -> CommonCode.MessageStatus.REQ -> MmsMtMessageService::modifyMtMessageQueue
                                                                          -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                                     -> ::sendMessage (실제 전송처리!!!)
                                          -> SktDeliverySubmit::toByte (메시지 전체 바이트 변환 - SOAP형태) -> 파일 전문 처리 -> 전체적으로 SOAP처리 -> 전체 byte변환
                                          -> OutputStream::write 

                                          ...ing...
                                          -> 최종 file에 대한 [덤프처리여부 => 덤프파일위치]덤프처리
                                          -> disconnect -> 연결끊음



# 설문 전체 라이프사이클 상태
등록 -> STAT:REGIST -> 승인 -> STAT:APPR -> 스케쥴:10분 -> STAT:RUNNING -> 스케쥴:3분 -> MSG_STAT:WAIT -> MQ:PUSH

## 설문 관련테이블
SURVEY(과금유형:surveyMsgTp(기존: LMS, MMS/추가: RCS_LMS, RCS_MMS))
   - 파일경로
      RcverPhoneNumFileUrl
      RcvRjtPhoneNumFileUrl
      SurveyAgreImgFilePath
      SurveyComplImgFilePath
      AgreCouponCdFileUrl
      CouponCdFileUrl

SURVEY_TRGTER
SURVEY_RCV_RJTER
SURVEY_AGRE_COUPON
SURVEY_QUST (설문질문 이미지/쿠폰등등)
* 나스(파일)경로


## MMS발송 요청
AsyncTaskSender::senderForMms 
      -> agent.properties.xml(/v1/sendMms) 
      -> SenderService::selectListSendAttFile -> ★ DB: 첨부파일 조회 -> SELECT(SND_ATTFILE)
      -> ★ 전송데이터 작성후 HTTP요청 
         -> ★ CloseableHttpClient::execute

### 프렘웍분석
## 최초시작
WebApplicationInitializer 
    -> AbstractContextLoaderInitializer
        -> AbstractAnnotationConfigDispatcherServletInitializer
            -> WebApplicationConfig
               -> SpringRootConfig
               -> SpringWebDataSourceConfig
               -> SpringSecurityConfig
                  -> Bean: AuthenticationManager
                  -> Bean: AuthenticationProvider
                  -> Bean: FilterChainProxy
               -> SpringWebConfig
               

    -> AbstractSecurityWebApplicationInitializer
    -> JerseyWebApplicationInitializer
    -> SpringBootServletInitializer

SpringServletContainerInitializer::onStartup -> StandardContext.java::startInternal -> 

# mmate_web
# 분석
## 초기실행
WebApplicationConfig::
    -> XSSServletFilter::doFilterInternal
        -> CommonsMultipartResolver::isMultipart
            -> 이면
                -> CommonsMultipartResolver::resolveMultipart (* 파일업로드...관련)
            -> 아니면
                -> /survey/saveSurvey
                    -> 이면
                        -> XssRequestWrapperForSurvey::createRequest
                    -> 아니면
                        -> XssRequestWrapper::createRequest

0. 로컬 기동됨....
http://localhost:8080/mmate-web-local/main
1. 인증처리
SpringSecurityConfig::(순서: authenticate -> filter)
      => authenticationProvider
         -> UsernameAuthenticationProvider::authenticate 
            -> CustomerContactService::loadUserByUsername 
               => 성공 
                  -> SecurityContextHolder.getContext.setAuthentication
               => 실패
                  -> 각 로그인 실패별 예외처리 throw ①
                  -> CustomerContactService::modifyLoginFail (실패 카운트)
      => UsernamePasswordAuthenticationFilter
         => 성공
            -> LoginSuccessHandler
         => 실패
            -> onAuthenticationFailure
               -> ① 로그인 실패 예외를 받아서 session에 저장

2. 로그인 화면 표시
LoginController::login
..ing

1. 설문제작
설문등록: SurveyController::registSurvey => surveyRegist.jsp=> SurveyController::saveSurvey
2. 설문수정
3. 설문통계
4. 설문통계 (상세리포트)
5. 설문통계 (설문 이력 조회)
6. 설문내역통계


## 프론트 잠깐 조사
1. JSP
- thymeleaf사용
2. 분석
프론트와 비지니스간 통신을 알아보기 위해 FAQ 등록에 관련하여 조사중....
테이블: FAQ 
JAVA: FaqController::registSave
JSP: faqRegist.jsp(faqId는 어디서 세팅되는지 찾는중...)
흐름: faq/list->faq/regist (여기서는 faqId를 hidden처리되어 있음)
INSERT쿼리 돌때마다 주키 시퀀스는 아래 설정된 sequence 쿼리를 이용한다.
```SQL
create sequence FAQ_SEQ start with 1 increment BY 1 maxvalue 999999999999999999;
```

### 조사
Message의 RlcID 는 무엇?

### 파일전성
1. properties::api.mms.attach.file.max 를 이용해서 파일 개수 설정

## 개발
1. Spring Boot 에서 RabbitMQ의 Template의 용도
- [Spring Boot AMQP](https://spring.io/projects/spring-amqp#overview)

2. Spring Event
- [イベントの伝播](https://www.techscore.com/tech/Java/Others/Spring/4-3/)

3. Spring Security
- [Hello World で学ぶ Spring Security の仕組み](https://qiita.com/opengl-8080/items/d4971ec4d2365c85ff99) <== 짱이네
- [Spring Security概要](https://terasolunaorg.github.io/guideline/5.1.0.RELEASE/ja/Security/SpringSecurity.html)
- [Spring Securityのお話](http://kozake.hatenablog.com/entry/2016/09/13/220328)
- [Spring Security認証周りについて](https://qiita.com/nannou/items/2363b37516f6228a4b9d) <== 비즈챗

4. Netty (SKT Client Channel) 
- [Nettyの紹介](https://www.codeflow.site/ja/article/netty)
- [Nettyを使ってサーバーを実装してみた](https://qiita.com/haoyu_ma/items/e1989ae752500521825b)
- [Nettyを使ってクライアントを実装してみた](https://qiita.com/haoyu_ma/items/3c501a1a263ee48d9581)

5. 파일업로드
- [ファイルアップロード](https://terasolunaorg.github.io/guideline/1.0.3.RELEASE/ja/ArchitectureInDetail/FileUpload.html)
- [Spring MVCによるファイルアップロード](https://www.codeflow.site/ja/article/spring-file-upload)
- [Spring MVC ファイルのアップロード](https://qiita.com/MizoguchiKenji/items/0aa1f2b385e73c36c24d)

6. Tika
- [Apache Tika](https://tika.apache.org/)

## Camel & Blocking & grpc
https://access.redhat.com/documentation/ja-jp/red_hat_fuse/7.5/html/fuse_on_openshift_guide/camel-spring-boot-starter
https://camel.apache.org/manual/latest/stream-caching.html
https://qiita.com/mkyz08/items/de1b2fd17eb372e1472d
https://jcug-oss.github.io/article/why-do-we-have-to-learn-camel-q
https://qiita.com/daikuro/items/5e22c78c0342fde04b87
https://codezine.jp/static/ad/index.html?ref=https%3A%2F%2Fcodezine.jp%2Farticle%2Fdetail%2F11673&1
https://jongz.hatenablog.com/entry/2018/12/11/031744
https://alwayspr.tistory.com/44

https://qiita.com/legokichi/items/1f3b1bd51e206ffdd2a6
https://www.kimullaa.com/entry/2016/12/09/000129#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0IO
https://b.hatena.ne.jp/kencharos/
https://qiita.com/klme_u6/items/ea155f82cbe44d6f5d88