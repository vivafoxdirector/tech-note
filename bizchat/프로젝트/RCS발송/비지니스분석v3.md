# 비지니스 분석
MMS설문등록 부터 승인 발송까지 분석한다. 분석내용은 20201028.md 파일 기준으로 추가 내용을 기술한다.

1. 설문 전체 라이프사이클 상태
등록 -> STAT:REGIST -> 승인 -> STAT:APPR -> 스케쥴:10분 -> STAT:RUNNING -> 스케쥴:3분 -> MSG_STAT:WAIT -> MQ:PUSH

# 비즈챗 Web 분석
자료: 비즈챗_RCS_Web_Wireframe_v0.3
기동방법: wiki->04.개발->개발서버프로세스체크
## 비지니스 비즈챗 web(v1.2.7,1.2.8)
1. 설문등록
고객사(web) -> 서비스관리 -> 설문조사 -> 설문제작 -> 등록
2. 설문조회-확인(web)
고객사(web) -> 서비스관리 -> 설문조사 -> 설문관리 -> 검색
3. 설문승인
어드민(admin) -> 서비스관리 -> 설문승인 -> 조회

## 이전설문불러오기
화면: 이전설문불러오기->리스트선택->불러오기(DB:SURVEY 상태 TEMP_SAVE)
SurveyController::beforeSurveyPupUp
   -> ProjectMgmtService::searchProjectList -> ProjectMapper::selectProjectList
      -> DB: 프로젝트 리스트
   -> 리스트선택 
      -> SurveyController::beforeSurvey 
         -> ProjectMapper::getBeforeSurvey -> DB: 이전 설문 취득 -> SELECT(SURVEY(SURVEY_STATE_CD:TEMP_SAVE))

## 설문등록(화면: 설문제작)
1. 등록시 타게팅 유무 분석
	- 타게팅 있을때(isUseTargetYn == true)
      - 설문동의 메시지에 [쿠폰코드 업로드] 가능하다.
		- DB: SURVEY(TGT_CND_USE_YN, TGT_CND_CONT)
	- 없을때 (isUseTargetYn == false)
      - 
/survey/surveyRegist -> surveyRegist.jsp
SurveyController::registSurvey => surveyRegist.jsp 
   -> 화면표시
      -> SurveyController::registSurvey      
         -> ChargeAndSpcNumService::searchCustomChargeBuyList -> DB: 요금제 구매 리스트 조회 -> SELECT(CHARGE_SVC)
         -> SurveyMgmtService::isUseTargetYn -> DB: 중계사 조회 -> SELECT(RLC)
         -> ChargeAndSpcNumService::getCustomSpcNumTotalCnt -> DB: 특번 카운트 조회 -> SELECT(custom_spc_num/custom_spc_num_svc/custom)
         -> ChargeAndSpcNumService::searchCustomSpcNumList -> DB: 특번 리스트 조회 -> SELECT(custom_spc_num/custom_spc_num_svc/custom)
         -> ProjectMgmtService::searchProjectList -> DB: 프로젝트 리스트 조회 -> SELECT(SURVEY_PROJECT/SURVEY/SYSTEM_USER)
         -> RETURN(VO: SurveyProjectVO)
   -> 등록
      -> SurveyController::saveSurvey(VO:ServeyVO)
         -> ChargeAndSpcNumService::searchCustomChargeBuyList -> DB: 요금제 구매 리스트 조회 -> SELECT(CHARGE_SVC)
         -> 등록&타게팅&수동발송체크해제
            -> SurveyMgmtService::checkSurveyCanRegist
               -> 기등록된 설문 및 예약 조회 -> SurveyMapper::selectSurveyBookingList -> DB: 설문조회(상태:'REGISTER','PRE_CHECK','CHECKING') -> SELECT(SURVEY)
               -> 루프처리(기등록된 설문 및 예약 설문)
                  -> BookingSchedule::registerBookingEntry -> 설문 스케쥴 등록처리
                  
               -> SURVEY SEQ 유무
                  -> 없으면 최초등록
                     -> 설문상태: REGISTER
                  -> 있으면
                     -> SurveyMapper::selectSurveyById -> DB: SURVEY_SEQ 조회
               -> BookingSchedule::makeBookingEntry
               -> BookingSchedule::canRegister
                  -> 
               -> BookingSchedule::showBookingEntry

         -> ProjectMgmtService::selectProject(VO:SurveyProjectVO) -> DB: 프로젝트 조회 -> SELECT(SURVEY_PROJECT/SURVEY/SYSTEM_USER)
         -> ★ 첨부 이미지처리(복수 이미지) -> 이미지 검증(Tika라이브러리/확장자 검증등) 
            -> ★ SurveyMgmtService::saveSurvey(SurveyVO/CustomerContactVO) -> DB: 설문 등록 ->    <== 이것을 RCS용도로 별도로 작성을 하는 방법 생각
               -> SurveyMapper::deleteSurveyTarget -> DB: 기존 데이터 삭제 -> DELETE(SURVEY_TRGTER)
               -> SurveyMapper::deleteSurveyRjtTarget -> DB: 기존 데이터 삭제 -> DELETE(SURVEY_RCV_RJTER)           
               -> ★ ::surveyFileUpload -> FileUtil.transferTo -> FILE: 이미지 업로드
               -> 상태
                  -> SurveyCode.SurveyStateCd.TEMP_SAVE (임시저장)
                  -> SurveyCode.SurveyStateCd.REGISTER (등록요청) !!!!!!
                     -> ★ SurveyMapper::insertSurvey -> DB: 설문 저장 -> INSERT(SURVEY)
                     -> ::saveMail -> 관리자 문자 알림
               -> 루프처리
                  -> ★ ::qustImgUpload(질문 이미지들) -> FileUtil.transferTo -> FILE: 질문 이미지 업로드
                     => PATH: $ROOT_PATH/$SURVEY_PATH/로그인ID/SURVEY_SEQ/Image카운트/파일명
                        ex) $ROOT_PATH/survey/2132/4024/0/09a0a03c7ffb4c169e4d636f4e9b819f.jpg
                  -> ★ ::surveyFileUpload(쿠폰) -> FileUtil.transferTo -> FILE: 쿠폰 이미지 업로드
                     => PATH: $ROOT_PATH/$SURVEY_PATH/로그인ID/"cpcd"/Image카운트/파일명
                        ex) $ROOT_PATH/survey/2132/cpcd/b5bdbe64e2814e06a0867b1585d06ab5.xlsx
                  -> ★ SurveyMapper::insertSurveyQuestion() -> DB:설문질문 이미지/쿠폰 등록 -> INSERT(SURVEY_QUST)
                     => 질문내용/쿠폰내용 둘다 저장된다. 질문1(1), 질문2(2), 쿠폰1(3), 쿠폰3(4) 순으로 하나의 테이블에 들어간다.
                        ```SQL
                        select * from SURVEY_QUST order by CRT_DTTM desc;  
                        ```
                  -> 쿠폰엑셀 파일에서 쿠폰코드를 가져온다.(이후 처리에서 저장)
                  -> SurveyMapper::insertSurveyCoupon -> DB: 쿠폰 코드 저장 -> INSERT(SURVEY_COUPON)
               -> 기존 쿠폰 삭제
                  -> DB: 기존 쿠폰 삭제 -> SurveyMapper::deleteOldSurveyCoupon -> DELETE(SURVEY_COUPON)
               -> 질문 1개이상
                  -> DB: 마지막 설문 SEQ 번호 갱신 -> SurveyMapper::updateLastQuestSeq -> UPDATE(SURVEY)
                  -> 루프처리
                     -> DB: 질문별로 답변 저장 -> SurveyMapper::insertSurveyAnswer -> INSERT(SURVEY_ANS)
            -> 성공/실패
               -> resultMap(surveySeq/resultMessage/resCd)               

설문조회
selectSurvey

화면: 설문관리
surveyList.jsp
SurveyController::getSurveyList

# 비즈챗 Admin 분석
## 설문승인(화면: 관리자->설문승인)
### 화면동작
uri:survey/reqlist -> 화면: 설문승인 -> surveyReqList.jsp -> 설문상태: REGISTER
   -> [승인]
      -> 타게팅이 있을때 처리
         -> 팝업이 뜬다. (승인이 비활성화 되어 있다.)

      -> 타게팅 없을때 처리
         -> /survey/updateState -> 설문상태: APPR

   -> [반려]


DB:SURVEY(TGT_CND_USE_YN) 
   => 화면:타게팅이 Y 인경우 
      => 설문:승인 => 팝업
         => 광고 수신자 동의 대사 제외 : Y
            설문상태: APPR 처리
         => 광고 수신자 동의 대사 제외 : N
            설문상태: PRE_CHECK
   => 화면:타게팅이 N 인경우
      => 설문상태: APPR 처리

SurveyMgmtService::updateTargetingSurvey
   -> ::getSurveyCanNextTime

booking(Y: 자동대사, M: 수동대사)
가중치(20%=1.2)

### 설문이력 사이클
1. Admin 에서 [승인]할 경우 최초 저장된다. (SurveyMapper::insertSurveyStateHistory)
2. ...ing

### 소스동작 (ADMIN)
1. 대시보드
- https://172.21.87.26:8200/dashboard => dashboard.jsp
DashboardController::dashboard
   -> CommonCodeService::searchCodeListByCdGrpId
      -> CodeMapper::selectCodeListByCdGrpId
         -> ★DB: 코드조회 (LMS, MMS) 취득 <= RCS_LMS, RCS_MMS추가해야함
            -> SELECT(COM_CD)
   -> StatisticsService::searchDataDashboardOfAdmin
      -> StatisticsMapper::selectDataDashboardOfAdmin
         -> ★DB: 통계 조회 <= RCS관련 코드 추가
            -> SELECT(STAT_DAYS, CUSTOM, COM_CD) => STAT_DAYS 통계테이블

2. 메시지관리&통계 > 전송완료메시지조회
- https://172.21.87.26:8200/notiMate/completeList => mtSndHistList.jsp
MateController::completeList
   -> MateService::selectDealerListByRlcId
      -> UserInfoMapper::selectDealerListByRlcId
         -> DB: 고객조회(딜러)
            -> SELECT(DLC)
   -> RLC? (고객조회)
      -> MateService::searchCustomUserPageListOfRlc
         -> UserInfoMapper::selectCustomUserListOfRlc
            -> DB: 사용자조회
               -> SELECT(SYSTEM_USER)
      -> MateService::searchCustomUserPageList
         -> UserInfoMapper::selectCustomUserList
            -> DB: 사용자조회
               -> SELECT(SYSTEM_USER)

   -> MateService::searchMtSndHistPageListByElastic
      -> ★::setElasticSearchParams (TODO: Elastic 조사해야함. 여기 유매니저한테 질문을 던져야 할듯)
      -> ★ ElasticSearchApi::callElasticApi
         -> Elastic: 조회        
      -> ★::setElasticResponseList
         -> Elastic으로 결과 리스트 작성한다. 
   -> ERROR
      -> MateService::searchMtSndHistPageList
         -> ★ DB: 전송 카운트 조회 및 목록 조회
            -> SELECT(mt_snd_hist)

3. 메시지관리&통계 > MT 요청 메시지 조회
- https://172.21.87.26:8200/notiMate/mtList => mtMsgQueueList.jsp
MateController::mtList
   -> ... [전송완료..조회] 같은 처리
   -> MateService::searchMtMsgQueuePageList
      -> MateService::selectMtMsgQueuePageList
         -> ★ DB: MT전송 메시지 조회
            -> SELECT(mt_msg_queue) => RCS는 유형에 포함되어 있어야 한다.(RCS_LMS, RCS_MMS)

4. 메시지관리&통계 > 설문 이력 조회
- https://172.21.87.26:8200/svMate/surveyHistList => surveyHistList.jsp
MateController::surveyHistList
   -> MateService::searchSurveyHistPageList
      -> SurveyHistMapper::selectSurveyHistPageList
         -> ★ DB: 설문 이력 조회
            -> SELECT(survey_hist)

5. 메시지관리&통계 > 고객사 전체 통계
- https://172.21.87.26:8200/stat/sv/all => statSvAll.jsp
StatisticsController::customsBySvAll
   -> ...
   -> ★ ::csAllSearchInitCommon => 화면에 표시되는 (SMS, LMS, MMS를 값 세팅)
      -> CommonCodeService::searchCodeListByCdGrpId
         -> CodeMapper::selectCodeListByCdGrpId
            -> ★ DB: MSG타입 조회
               -> SELECT(COM_CD)

   -> ★ StatisticsSvService::searchDataByCustomsAll
      -> StatisticsSvMapper::selectDataByCustomsAll
         -> DB: 전체 통계 조회
            -> SELECT(SURVEY_HIST, CUSTOM, SURVEY_PARTCPTN)
               -> ★ statisticsBySv.sqlmap.xml => selectStatSurveyHist 수정
   -> 결과(tableDataList)

6. 메시지관리&통계 > 고객사 비교 통계
- https://172.21.87.26:8200/stat/cs => statCs.jsp
StatisticsController::customs
   -> ::cs
      -> StatisticsCsService::selectDataByCustoms
         -> StatisticsCsMapper::selectDataByCustoms
            -> DB: 조회
               -> SELECT(CUSTOM, consult_bill_hist)
                  -> ★ statisticsByCs.sqlmap.xml =>orderSql 수정
   -> 결과(tableDataList)

6. 메시지관리&통계 > 고객사별 상세 통계
- https://172.21.87.26:8200/stat/cs/custom => 
StatisticsController::custom
   -> ::cs -> :: csCustom
      -> StatisticsCsService::searchDataByCustom
         -> StatisticsCsMapper::selectDataByCustom
         -> StatisticsCsMapper::selectDataOfSpcNumsByCustom
            -> DB: 조회
               -> SELECT(custom,consult_bill_hist, consult_bill_hist_detail)
   -> 결과(tableDataList)

6-1. 메시지관리&통계 > 고객사별 상세 통계 > 상세내역
- https://172.21.87.26:8200/stat/cs/custom/detail => statCsCustomPaging.jsp
- StatisticsController::customByPaging
   -> ::cs -> ::csCustomDetail
      -> ::setTableDataSearchGubunByCs => 구분값 취득
      -> StatisticsCsService::searchDataOfDetailByPaging
         -> ::searchDataOfDetailByPaging
            -> StatisticsCsMapper::selectDataByDaysOfPaging
            -> StatisticsCsMapper::selectDataByDaysOfTelecomsOfPaging
            -> StatisticsCsMapper::selectDataByDaysOfSpcNumsOfPaging
            -> StatisticsCsMapper::selectDataByDaysOfTelecomsSpcNumsOfPaging
            -> StatisticsCsMapper::selectDataByDaysOfDealPaging
               -> SELECT(custom, consult_bill_hist, consult_bill_hist_detail)
   -> 결과 (list)

6-2. 메시지관리&통계 > 고객사별 상세 통계 > 상세 통계(상담 이력 조회)
- https://172.21.87.26:8200/stat/cs/consultHist

2. 설문리스트(갱신)
화면: 설문 리스트 (surveyReqList.jsp) -> 설문승인 동작
SurveyController::getSurveyReqlist
   -> SurveyMgmtService::searchSurveyRequestList -> DB: 설문승인 예정 조회 -> SELECT(SURVEY/SYSTEM_USER/CUSTOM/SURVEY_PROJECT)

SurveyController::updateState(설문상태: APPR)
   -> SurveyMgmtService::updateSurveyState
      -> 수신자 번호 파일(등록시 입력) 있다. (타겟팅 수신자 X, 수신자 번호 O)
         -> SurveyMgmtService::updateTargetingSurvey
            -> 정보광고 수신 동의 대사 제외 (승인시 처리 기본 N 동의 아니다.) 이면서 수동(M:등록시)발송이 아닌경우 (수동발송 요청 X)
               -> 스케쥴 처리
            -> 정보광고 수신 동의 대사 제외 (CheckingExcept: Y)
               -> SurveyCode.SurveyStateCd.APPR -> 설문상태: APPR
            -> 제외가 아니면 대사 배치 수행 (CheckingExcept: N)
               -> SurveyCode.SurveyStateCd.PRE_CHECK -> 설문상태: PRE_CHECK
            -> DB: deleteSurveyTarget, moveSurveyTarget, updateSurveyForTarget, insertSurveyStateHistory
            
      -> 수신자 번호 파일(등록시 입력) 없으면
         -> 설문상태: APPR
            -> SurveyMapper::updateSurveyState -> DB: 설문상태 갱싱 -> UPDATE(SURVEY)
            -> ★ SurveyMapper::insertSurveyStateHistory -> DB: 설문 이력 저장 -> INSERT(SURVEY_HISTORY)
      -> 메일 보내기 (★ 메일 타이틀 작성시 RCS는 별도로 하는가?)
         -> SurveyMgmtService::saveMail
            => mail.message.xml
            => 초기화: SpringAdminConfig.java
         

# 스케쥴러 분석(mmate-survey-agent)
## 초기실행
BootStrap::start ->
   SenderApplicationConfig
      -> BEAN: MessageSource
      -> BEAN: ThreadPoolTaskScheduler
      -> ★ BEAN: SchedulerSendMsgSearchTask
      -> BEAN: SchedulerMoveTask

### 10분 (설문상태: APPR -> RUNNING 처리)

SchedulerStartSurveyTask::startSurvey
   -> SurveyMapper::selectSurveyForScheduler -> 설문상태: APPR -> DB: 설문상태(APPR) 조회 -> SELECT(SURVEY)
      -> 루프처리(APPR리스트)
         -> ::startSurvey(SurveySeq별로 루프)
            -> 설문 정보
               -> SurveyMapper::selectSurvey -> DB: 설문조회 -> SELECT(SURVEY)
            -> 동시간대 진행중인 설문중 중복 MDN 처리
               -> SurveyMapper::updateSurveyDupTrgter -> 설문상태: RUNNING -> DB: 설문상태 갱신 -> UPDATE(SURVEY_TRGTER) 
            -> 발송대상자
               -> SurveyMapper::selectSurveyTrgter -> DB: 대상자 조회 -> SELECT(SURVEY_TRGTER)
            -> 고객특번확인
               -> getCustomSpcNumList
            -> 비즈챗 사용확인
               -> getCustomSvcList
            -> ★ 루프처리
               -> ★ 이미지PATH 없음(SurveyVO::SurveyAgreImgFilePath => 코폰이미지)
                  -> SMS/LMS 처리
               -> ★ 이미지PATH 있음
                  -> MMS 처리
            -> ★ SenderService::createSndMsgBatch 
               -> SenderMapper::insertSndMsgBatch -> DB: 메시지 저장 -> INSERT(SND_MSG(SURVEY_SEQ포함)=> MSG_TP (SMS/LMS/MMS)) => ★RCS용도로 SND_MSG에 관련내용을 포함할 것인가...고민
            -> 설문동의 이미지가 있으면
               -> SenderService::selectMsgSeqListBySurveySeq -> DB: MSG_SEQ 가져오기 -> SELECT(SND_MSG)
               -> ★ SenderService::createSndAttrFileBatch (첨부이미지 저장처리)
                  -> ★ SenderMapper::insertSndAttrFileBatch -> DB: 이미지정보 저장 -> INSERT(SND_ATTFILE) 

         -> 상태: RUNNING
         -> 상태: ERROR
         -> updateSurveyStateCd -> DB: 설문상태 RUNNING/ERROR 갱신 -> UPDATE(SURVEY)
   
### 3분 (RUNNING -> MQ:REQUEST:PUSH)
★ SchedulerSendMsgSearchTask
   -> ::sendLms
   -> ::sendSms
   -> ★ ::sendMms
      -> SurveyService::getSurveyByStateAndDate
         -> DB: 설문 RUNNING 상태 조회 -> SELECT(SURVEY)
      -> SenderService::searchListSendMsgForMms => 리스트 개수 취득
         -> DB: 메시지 내용 조회 -> SELECT(SND_MSG) -> SND_MSG 에서 MMS이고, SURVEY_SEQ인 리스트 취득
      -> 루프처리(설문상태:running 개수만큼 )
         -> SenderService::searchListSendMsgForMms -> SURVEY_SEQ당 SND_MSG 리스트 취득
            -> SenderService::modifyListSndStepStateToReqIng -> SND_MSG(SND_STEP_STATE:REQING) -> SND_MSG 상태갱신 
            -> 루프처리 (SND_MSG 리스트 만큼)
               -> 대기큐 처리 (★ 중요)
               -> 루프처리 (대기큐 성공까지)
                  -> MtMessageService::saveSendMessage
                     -> ★ 많은일을 한다.
                     -> 키워드&쿠폰있으면
                        -> ★ SurveyService::getAgreGuideReMsgWithAgreCoupon => 쿠폰 발급 및 치환처리
                        -> 쿠폰코드 소진이면 메시지 발송 안함.
                           -> SND_MSG(SND_STEP_STATE:REQCANCEL) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)
                     -> MtMsgQueueVO(CustomReqId=SndMsg:MSG_SEQ 포함)
                     -> ::createMtMsgQueue(MtSndReqVO, MtMsgQueueVO, MtMsgQueueBinVO)
                        -> DB: 정보입력 -> INSERT(MT_SND_REQ)
                        -> DB: 정보입력 -> INSERT(★ MT_MSG_QUEUE)
                        -> DB: 이미지 정보입력 -> INSERT(MT_MSG_QUEUE_BIN)
                     -> ★ MessageQueueSender::sendMtMgrRequest(MtMessage) -> MessageStatus.WAIT -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH
                     -> SND_MSG(SND_STEP_STATE:WAIT) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)
                  -> 예외 발생
                     -> SND_MSG(SND_STEP_STATE:REQFAIL) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)

### 수신부분 ...ing
SurveyService::sendAnsErrNotiMsg
SurveyService::sendSurveyCoupon -> sendMsg
ReceiveMsgHandler::sendSurvey -> SurveyService::sendSurveyCoupon
ReceiveMsgHandler::sendSurvey -> SurveyService::sendSurveyQuestion
   -> createSndMsg ->insertSndMsg -> DB: 메시지 저장 -> INSERT(SND_MSG)

# MQ매니저 mmate-mt-mgr 분석
MSG_REQUEST 
9. MMS 전송 결과 MQ Push
MtMgrRequestQueueListener::onMessage 
   -> MtMgrService::searchMtMsgQueueInfo
      -> DB: 조회 -> SELECT(MT_MSG_QUEUE[userid, mtqueueid])
   -> DeviceCacheService::findDeviceInfo
      -> CACHE: 조회 -> JPA(device)
   -> MtMgrService::modifyMtMsgQueue -> MessageStatus.REQ or FAIL -> QUEUE상태 갱신
      -> DB: 갱신 -> UPDATE(MT_MSG_QUEUE)
   -> 성공여부 
      -> 실패 -> MtMgrService::sendMtMgrReultByFinalFail
                  -> MtMgrResultSenderByFinalFail::sendMtMgrResult -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
      -> 성공
         -> SKT아닌경우(AGENT를 통해 발송)
            -> RlcAgentService::saveInfoBackMtMessage
         -> SKT경우
            -> MtMgrService::sendMsgReq (메시지별 직접 통신사 송신)
               -> SMS:MtSmsSender::sendMtSmsSktRequest -> MQ:PUSH
               -> LMS:MtMmsSender::sendMtMmsSktRequest -> MQ:PUSH
               -> MMS:MtMmsSender::sendMtMmsSktRequest -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH

# mms client
MmsSktClient::toSubmit -> SktDeliverySubmit -> 최종 딜리버리용 객체를 만든다.이것을 이용하여 RCS도 이용하도록 한다.

..ing

@@@#@#@#@#
MtMsgQueueVO 클래스와 MtMsgQueueVO용도의 DB스키마를 RCS용을 추가하면 어떨까 싶다.

* MMS같은 경우 MtMsgQueue를 MtMsgQueueInfo에 파일과 컨텐츠를 담아서 클라이언트에 전송을 한다.
MmsSendManager::sendMessage ->  MmsSktClient::sendMessage(MtMsgQueueInfo)
* RCS라면 위와 비슷하게 처리하도록 고민해보자..


9-1. SKT MMS Client (메시지 복호화 처리 -> 파일정보 -> 발송 큐에 적재)
MmsSktQueueListener::onMessage -> QueueName.MT_MMS.MT_MMS_SKT -> ::findMtMsgQueue -> MmsMtMessageService::findMtMessageQueue -> 메시지 복호화 처리
                                                                                        -> DB : 조회 -> SELECT(MT_MSG_QUEUE[mtqueueid])
                               -> RclID 없다면
                                  -> CustomerService::findCustomerDetail -> DB: RclID 조회 -> 존재여부 -> 실패 -> 예외
                               -> RclID 있다면 (단말기 발송처리!!!!)
                                  -> MmsSendManager::sendMessage -> MmsMtMessageService::searchMtMessageQueueFileList
                                                                      -> MmsMtMessageService::selectMtMsgQueueBinList
                                                                        -> DB: 단말기 MMS 첨부파일 조회 -> SELECT(MT_MSG_QUEUE_BIN)
                                                                      -> MmsSktClient::sendMessage -> queue:put
9-2. SKT MMS Client (발송 큐에서 메시지 취득후 발송후 단말로 부터 Submit RES 메시지 받는다. (발송에 대한 결과값이 반환이 아니다.))
MmsSktClient::run -> 연결이 끊어져있다면
                    -> Queue의 모든 메시지 -> MessageStatus.RETRY -> MmsSktQueueSender::sendMtMgrRequest
                  -> 연결되어 있다면
                    -> ::queue::poll -> CommonCode.MessageStatus.REQ -> MmsMtMessageService::modifyMtMessageQueue
                                                                          -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                                     -> ::sendMessage (실제 전송처리!!!)
                                          -> SktDeliverySubmit::toByte (메시지 전체 바이트 변환 - SOAP형태) -> 파일 전문 처리 -> 전체적으로 SOAP처리 -> 전체 byte변환
                                             -> MmsUtils::readFile (이미지 byte)
                                          -> OutputStream::write 

                                          ...ing...
                                          -> 최종 file에 대한 [덤프처리여부 => 덤프파일위치]덤프처리
                                          -> disconnect -> 연결끊음

# 설문 전체 라이프사이클 상태
등록 -> STAT:REGIST -> 타게팅 -> PRE_CHECK -> 승인 -> STAT:APPR -> 스케쥴:10분 -> STAT:RUNNING -> 스케쥴:3분 -> MSG_STAT:WAIT -> MQ:PUSH

* 관련테이블
SURVEY(과금유형:surveyMsgTp(기존: LMS, MMS/추가: RCS_LMS, RCS_MMS))
   - 파일경로
      RcverPhoneNumFileUrl
      RcvRjtPhoneNumFileUrl
      SurveyAgreImgFilePath
      SurveyComplImgFilePath
      AgreCouponCdFileUrl
      CouponCdFileUrl

SURVEY_TRGTER
SURVEY_RCV_RJTER
SURVEY_AGRE_COUPON
SURVEY_QUST (설문질문 이미지/쿠폰등등)
* 나스(파일)경로


## MMS발송 요청
AsyncTaskSender::senderForMms 
      -> agent.properties.xml(/v1/sendMms) 
      -> SenderService::selectListSendAttFile -> ★ DB: 첨부파일 조회 -> SELECT(SND_ATTFILE)
      -> ★ 전송데이터 작성후 HTTP요청 
         -> ★ CloseableHttpClient::execute

### 프렘웍분석
## 최초시작
WebApplicationInitializer 
    -> AbstractContextLoaderInitializer
        -> AbstractAnnotationConfigDispatcherServletInitializer
            -> WebApplicationConfig
               -> SpringRootConfig
               -> SpringWebDataSourceConfig
               -> SpringSecurityConfig
                  -> Bean: AuthenticationManager
                  -> Bean: AuthenticationProvider
                  -> Bean: FilterChainProxy
               -> SpringWebConfig
               

    -> AbstractSecurityWebApplicationInitializer
    -> JerseyWebApplicationInitializer
    -> SpringBootServletInitializer

SpringServletContainerInitializer::onStartup -> StandardContext.java::startInternal -> 

# mmate_web
# 분석
## 초기실행
WebApplicationConfig::
    -> XSSServletFilter::doFilterInternal
        -> CommonsMultipartResolver::isMultipart
            -> 이면
                -> CommonsMultipartResolver::resolveMultipart (* 파일업로드...관련)
            -> 아니면
                -> /survey/saveSurvey
                    -> 이면
                        -> XssRequestWrapperForSurvey::createRequest
                    -> 아니면
                        -> XssRequestWrapper::createRequest

0. 로컬 기동됨....
http://localhost:8080/mmate-web-local/main
1. 인증처리
SpringSecurityConfig::(순서: authenticate -> filter)
      => authenticationProvider
         -> UsernameAuthenticationProvider::authenticate 
            -> CustomerContactService::loadUserByUsername 
               => 성공 
                  -> SecurityContextHolder.getContext.setAuthentication
               => 실패
                  -> 각 로그인 실패별 예외처리 throw ①
                  -> CustomerContactService::modifyLoginFail (실패 카운트)
      => UsernamePasswordAuthenticationFilter
         => 성공
            -> LoginSuccessHandler
         => 실패
            -> onAuthenticationFailure
               -> ① 로그인 실패 예외를 받아서 session에 저장

2. 로그인 화면 표시
LoginController::login
..ing

1. 설문제작
설문등록: SurveyController::registSurvey => surveyRegist.jsp=> SurveyController::saveSurvey
2. 설문수정
3. 설문통계
4. 설문통계 (상세리포트)
5. 설문통계 (설문 이력 조회)
6. 설문내역통계

## 상태값


SND_MSG
   - REQING
   - WAIT
   - RESULT
   - REQCANCEL: 신규 발급할 쿠폰이 없는 경우,...
   - REQFAIL

## 프론트 잠깐 조사
1. JSP
- thymeleaf사용
2. 분석
프론트와 비지니스간 통신을 알아보기 위해 FAQ 등록에 관련하여 조사중....
테이블: FAQ 
JAVA: FaqController::registSave
JSP: faqRegist.jsp(faqId는 어디서 세팅되는지 찾는중...)
흐름: faq/list->faq/regist (여기서는 faqId를 hidden처리되어 있음)
INSERT쿼리 돌때마다 주키 시퀀스는 아래 설정된 sequence 쿼리를 이용한다.
```SQL
create sequence FAQ_SEQ start with 1 increment BY 1 maxvalue 999999999999999999;
```

### 조사
Message의 RlcID 는 무엇?

### 파일전성
1. properties::api.mms.attach.file.max 를 이용해서 파일 개수 설정