# 비지니스 분석
MMS설문등록 부터 승인 발송까지 분석한다. 분석내용은 20201028.md 파일 기준으로 추가 내용을 기술한다.

1. 설문 전체 라이프사이클 상태
등록 -> STAT:REGIST -> 승인 -> STAT:APPR -> 스케쥴:10분 -> STAT:RUNNING -> 스케쥴:3분 -> MSG_STAT:WAIT -> MQ:PUSH

# 비즈챗 Web 분석
자료: 비즈챗_RCS_Web_Wireframe_v0.3
기동방법: wiki->04.개발->개발서버프로세스체크
## 비지니스 비즈챗 web(v1.2.7,1.2.8)
1. 설문등록
고객사(web) -> 서비스관리 -> 설문조사 -> 설문제작 -> 등록
2. 설문조회-확인(web)
고객사(web) -> 서비스관리 -> 설문조사 -> 설문관리 -> 검색
3. 설문승인
어드민(admin) -> 서비스관리 -> 설문승인 -> 조회

## 이전설문불러오기
화면: 설문제작->이전설문불러오기->리스트선택->불러오기 (설문상태: NOT IN (TEMP_SAVE))
SurveyController::beforeSurveyPupUp => beforeSurveyPupUp.jsp
   -> ProjectMgmtService::searchProjectList -> ProjectMapper::selectProjectList
      -> DB: 프로젝트 리스트
   -> 리스트선택
      -> ::beforeSurvey
         -> ProjectMapper::getBeforeSurvey
            -> 설문상태: TEMP_SAVE 빼고 전부 -> DB: 이전 설문 취득 -> SELECT(SURVEY(SURVEY_STATE_CD: NOT IN (TEMP_SAVE)))
   -> 불러오기
      -> /survey/detail?
         isReUse=true         => isReUse 이전설문 불러오기
         isRegist=tru
         surveySeq=
      -> ::getSurveyDetail => surveyRegist.jsp
   -> surveyRegist.jsp 에서 팝업 선택 설문 불러오기
      -> /survey/detailinfo
      -> ★ SurveyController::getSurveyDetailInfo
         -> ★★ SurveyMgmtService::getSurveyRcsInfo
         -> ★★ SurveyMgmtService::getSurveyRcsBtnInfo

## 임시보관함
화면: 설문제작 -> 임시보관함 -> 팝업 (설문상태: TEMP_SAVE) -> 리스트 조회
SurveyController::tempSurveyListPupUp => tempSurveyPupUp.jsp
   -> SURVEY_STATE:TEMP_SAVE => 설문상태: TEMP_SAVE
   -> SurveyMgmtService::searchSurveyPageList
      -> SurveyMapper::getSurveyTotalCount
         -> DB: TEMP_SAVE 설문 개수 조회 -> SELECT(SURVEY/SYSTEM_USER/SURVEY_PROJECT)
      -> SurveyMapper::selectSurveyList
         -> DB: TEMP_SAVE 설문 조회 -> SELECT(SURVEY)

화면동작: 불러오기 => /survey/detail?surveySeq=XXX
   -> 동작은 위 [이전설문불러오기]와 같음


## 설문등록(화면: 설문제작, 설문 등록상태:REGISTER)
1. 등록시 타게팅 유무 분석
	- 타게팅 있을때(isUseTargetYn == true)
      - 설문동의 메시지에 [쿠폰코드 업로드] 가능하다.
		- DB: SURVEY(TGT_CND_USE_YN, TGT_CND_CONT)
	- 없을때 (isUseTargetYn == false)
      - 
/survey/surveyRegist -> surveyRegist.jsp
SurveyController::registSurvey => surveyRegist.jsp 
   -> 화면표시
      -> SurveyController::registSurvey      
         -> ChargeAndSpcNumService::searchCustomChargeBuyList -> DB: 요금제 구매 리스트 조회 -> SELECT(CHARGE_SVC)
         -> SurveyMgmtService::isUseTargetYn -> DB: 중계사 조회 -> SELECT(RLC)
         -> ChargeAndSpcNumService::getCustomSpcNumTotalCnt -> DB: 특번 카운트 조회 -> SELECT(custom_spc_num/custom_spc_num_svc/custom)
         -> ChargeAndSpcNumService::searchCustomSpcNumList -> DB: 특번 리스트 조회 -> SELECT(custom_spc_num/custom_spc_num_svc/custom)
         -> ProjectMgmtService::searchProjectList -> DB: 프로젝트 리스트 조회 -> SELECT(SURVEY_PROJECT/SURVEY/SYSTEM_USER)
         -> RETURN(VO: SurveyProjectVO)
   -> 등록
      -> SurveyController::saveSurvey(VO:ServeyVO)
         -> ChargeAndSpcNumService::searchCustomChargeBuyList -> DB: 요금제 구매 리스트 조회 -> SELECT(CHARGE_SVC)
         -> 등록&타게팅&수동발송체크해제
            -> SurveyMgmtService::checkSurveyCanRegist
               -> 기등록된 설문 및 예약 조회 -> SurveyMapper::selectSurveyBookingList -> DB: 설문조회(상태:'REGISTER','PRE_CHECK','CHECKING') -> SELECT(SURVEY)
               -> 루프처리(기등록된 설문 및 예약 설문)
                  -> BookingSchedule::registerBookingEntry -> 설문 스케쥴 등록처리
               -> SURVEY SEQ 유무
                  -> 없으면 최초등록
                     -> 설문상태: REGISTER
                  -> 있으면
                     -> SurveyMapper::selectSurveyById -> DB: SURVEY_SEQ 조회
               -> BookingSchedule::makeBookingEntry
               -> BookingSchedule::canRegister
                  -> 
               -> BookingSchedule::showBookingEntry

         -> ProjectMgmtService::selectProject(VO:SurveyProjectVO) -> DB: 프로젝트 조회 -> SELECT(SURVEY_PROJECT/SURVEY/SYSTEM_USER)
         -> ★ 첨부 이미지처리(복수 이미지) -> 이미지 검증(Tika라이브러리/확장자 검증등) 
            -> ★ SurveyMgmtService::saveSurvey(SurveyVO/CustomerContactVO) -> DB: 설문 등록 ->    <== 이것을 RCS용도로 별도로 작성을 하는 방법 생각
               -> 이전설문 불러오기
                  -> 처리
               -> 타게팅 수신자 내용 존재 X && 수신자 파일 존재 〇
                  -> 처리
               -> 수신거부 파일 존재 X && 이전설문 〇
                  -> 처리
               -> 수신자 폰 파일 존재 〇 && 임시저장
                  -> SurveyMapper::deleteSurveyTarget -> DB: 기존 데이터 삭제 -> DELETE(SURVEY_TRGTER)
               -> 수신자 거부 폰 파일 존재 〇 && 임시저장
                  -> SurveyMapper::deleteSurveyRjtTarget -> DB: 기존 데이터 삭제 -> DELETE(SURVEY_RCV_RJTER)
               -> 수신자 폰넘버 파일 존재 〇
                  -> ::surveyFileUpload -> FileUtil.transferTo -> FILE: 지정 파일 패스로 업로드
               -> 수신자 거부 폰넘버 파일 존재 〇
                  -> ::surveyFileUpload -> FileUtil.transferTo -> FILE: 지정 파일 패스로 업로드
               -> 설문 동의 이미지 존재 〇
                  -> ★ ::surveyFileUpload -> FileUtil.transferTo -> FILE: 이미지 업로드
               -> 설문 완료 이미지 존재 〇
                  -> ★ ::surveyFileUpload -> FileUtil.transferTo -> FILE: 이미지 업로드
               -> 설문 동의 쿠폰 파일 존재 〇
                  -> ::surveyFileUpload -> FileUtil.transferTo -> FILE: 이미지 업로드
                  -> SURVEY_VO:setAgreCouponCdFileUrl
                  -> SURVEY_VO:setAgreCouponFileOrgnlNm
                  -> SURVEY_VO:setAgreCouponFileSize
               -> Survey.SEQ 존재 〇
                  -> ::delete
                  -> SurveyMapper::updateSurvey
               -> Survey.SEQ 존재 X
                  -> SurveyCode.SurveyStateCd.TEMP_SAVE (임시저장)
                  -> SurveyCode.SurveyStateCd.REGISTER (등록요청) !!!!!!
                  -> ★ SurveyMapper::insertSurvey -> DB: 설문 저장 -> INSERT(SURVEY)
               -> 수신자 리스트 존재 〇
                  -> SurveyMapper::insertSurveyTarget
                     -> DB: 타겟 수신자 입력(SURVEY_SEQ, 폰번호 등등) -> INSERT(SURVEY_TRGTER)
               -> 수신자 거부자 리스트 존재 〇
                  -> SurveyMapper::insertSurveyRjtTarget
                     -> DB: 타겟 수신거부자 입력(SURVEY_SEQ, 폰번호 등등) -> INSERT(SURVEY_RCV_RJTER)
               -> SurveyMapper::updateSurveyTarget
                  -> DB: 타겟 수신자 갱신 하면서 갱싱 카운트 취득 -> UPDATE(SURVEY_TRGTER)
               -> 응답 메시지 설정 (총수신 대상자 건수, 수신거부 건수 )
               -> 쿠폰코드리스트 존재 〇
                  -> 루프(설정:엑셀 타켓 카운트: 기본값: 1500)
                     -> SurveyMapper::insertSurveyAgreCoupon
                        -> DB: 쿠폰 정보 등록(SURVEY_SEQ, SURVEY_AGRE_COUPON_CD, COUPON_STATE_CD) -> INSERT(SURVEY_AGRE_COUPON)
         -> ::saveMail -> 관리자 문자 알림
               -> 루프처리
                  -> ★ ::qustImgUpload(질문 이미지들) -> FileUtil.transferTo -> FILE: 질문 이미지 업로드
                     => PATH: $ROOT_PATH/$SURVEY_PATH/로그인ID/SURVEY_SEQ/Image카운트/파일명
                        ex) $ROOT_PATH/survey/2132/4024/0/09a0a03c7ffb4c169e4d636f4e9b819f.jpg
                  -> ★ ::surveyFileUpload(쿠폰) -> FileUtil.transferTo -> FILE: 쿠폰 이미지 업로드
                     => PATH: $ROOT_PATH/$SURVEY_PATH/로그인ID/"cpcd"/Image카운트/파일명
                        ex) $ROOT_PATH/survey/2132/cpcd/b5bdbe64e2814e06a0867b1585d06ab5.xlsx
                  -> ★ SurveyMapper::insertSurveyQuestion() -> DB:설문질문 이미지/쿠폰 등록 -> INSERT(SURVEY_QUST)
                     => 질문내용/쿠폰내용 둘다 저장된다. 질문1(1), 질문2(2), 쿠폰1(3), 쿠폰3(4) 순으로 하나의 테이블에 들어간다.
                        ```SQL
                        select * from SURVEY_QUST order by CRT_DTTM desc;  
                        ```
                  -> 쿠폰엑셀 파일에서 쿠폰코드를 가져온다.(이후 처리에서 저장)
                  -> SurveyMapper::insertSurveyCoupon -> DB: 쿠폰 코드 저장 -> INSERT(SURVEY_COUPON)
               -> 기존 쿠폰 삭제
                  -> DB: 기존 쿠폰 삭제 -> SurveyMapper::deleteOldSurveyCoupon -> DELETE(SURVEY_COUPON)
               -> 질문 1개이상
                  -> DB: 마지막 설문 SEQ 번호 갱신 -> SurveyMapper::updateLastQuestSeq -> UPDATE(SURVEY)
                  -> 루프처리
                     -> DB: 질문별로 답변 저장 -> SurveyMapper::insertSurveyAnswer -> INSERT(SURVEY_ANS)
            -> 성공/실패
               -> resultMap(surveySeq/resultMessage/resCd)

## WEB 설문관리:조회(화면: 설문관리)
SurveyController::getSurveyList => survey/list => surveyList.jsp
   -> SurveyMgmtService::searchSurveyPageList
      -> SurveyMapper::getSurveyTotalCount
         -> DB: 설문 조회 개수 -> SELECT(SURVEY)
      -> SurveyMapper::selectSurveyList
         -> DB: 설문 조회 -> SELECT(SURVEY) => survey.sqlmap.xml

### 설문관리:조회 > 설문결과 > 엑셀 다운로드
SurveyController::downloadSurveyResultExcel

## WEB 설문관리:테스트발송(화면: 설문관리, 설문상태: RUNNING 상태 변경 => 3초 스케쥴로 넘어감)
1. 테스트 발송 => surveyList.jsp
SurveyController::getSurveyList => surveyList.jsp
   => 테스트 발송
      -> SurveyController::sndTestSurvey
         -> SurveyMgmtService::saveTestSurvey -> SurveyMapper::selectOrgSurvey
            -> SURVEY:TITLE => "TEST_"키워드 붙임
            -> SURVEY:RUNNING => 상태 변경
            -> SurveyMapper::insertTestSurvey
               -> DB: TEST설문 저장 -> INSERT(SURVEY)
            -> SurveyMapper::insertSurveyTarget
               -> DB: 타겟 정보 저장 -> INSERT(SURVEY_TRGTER)
            -> SurveyMapper::selectSurveyQuestionList
               -> DB: 질문 리스트 취득 -> SELECT(SURVEY_QUST)
            -> 질문루프처리
               -> SurveyMapper::insertSurveyQuestion => 원본 SURVEY SEQ 질문을 조회하여 TEST SEQ에 해당하는 질문으로 등록처리
                  -> DB: 질문 저장 -> INSERT(SURVEY_QUST)
               -> 쿠폰 존재 〇
                  -> SurveyMapper::insertTestSurveyCoupon
                     -> DB: 쿠폰 저장 -> INSERT(SURVEY_COUPON)
               -> SurveyMapper::selectSurveyAnswerList
                  -> DB: 원본 SURVEY 답변 조회 -> SELECT(SURVEY_ANS)
            -> 동의 쿠폰코드 존재 〇
               -> SurveyMapper::insertTestSurveyAgreCoupon
                  -> DB: 동의 쿠폰 저장 -> INSERT(SURVEY_AGRE_COUPON)
            -> SurveyMapper::updateLastQuestSeq
               -> DB: 설문 마지막 질문 SEQ 갱신 -> UPDATE(SURVEY)
            -> 답안루프처리
               -> SurveyMapper::insertSurveyAnswer
                  -> DB: 테스트용 질문 답안 저장 처리 -> INSERT(SURVEY_ANS)
            -> SurveyMapper::insertSurveyStateHistory
               -> SURVEY:APPR => 상태변경
               -> DB: 설문 이력 상태 변경 갱신 -> UPDATE(SURVEY_STATE_UPD_HIST)
            -> SurveyService::startSurvey => 테스트용 설문 발송!!!
               -> ★★::sendSurvey => RCS_LMS/RCS_MMS 일때 대응이 되어야 한다.
                  -> SurveyMapper::updateSurveyDupTrgter
                     -> DB: 동시간대 진행중인 설문중 중복 MDN처리 -> UPDATE(SURVEY_TRGTER)
                  -> SurveyMapper::selectSurveyTrgter
                     -> DB: 타겟 수신자 조회 -> SELECT(SURVEY_TRGTER)
                  -> SurveyMapper::selectCustomSpcNumList
                     -> DB: 특번조회 -> SELECT(custom_spc_num)
                  -> SurveyMapper::selectCustomSvcList
                     -> DB: 설문 비즈챗 사용여부 조회 -> SELECT(CHARGE_SVC)
                  -> ★★ 타겟 수신자 루프처리
                     -> SurveyMapper::selectSurveyJoinInfo
                        -> DB: 설문 완료자 조회 -> SELECT(SURVEY_PARTCPTN)
                     -> 동의 안내 메시지 존재 〇
                        -> LMS/MMS
                           -> SenderService::createSndMsg
                              -> ...ing
                              -> SenderMapper::insertSndMsg
                     -> 메시지 타입 : RCS_LMS/RCS_MMS
                        -> SenderService::createSndMsg
                           -> ...ing
                           -> SenderMapper::insertSndMsg

## WEB 설문관리:수정
SurveyController::getSurveyList => surveyList.jsp
수정:/survey/checkModifySurvey
SurveyController::checkRunnintTestCouponSurvey => surveyList.jsp
   => 완료되지(RUNNING) 않은 설문인지 아닌지 판단
      -> SurveyMgmtService::getCountRunningRefCouponSurveySeq
         -> SurveyMapper::getCountRunningRefCouponSurveySeq
            -> DB: 상태:RUNNING 완료 되지 않은 설문 카운트 조회 -> SELECT(SURVEY/survey_partcptn/survey_coupon)
   => RUNNING 이외의 설문
      -> /survey/detail?
         surveySeq=세팅
         isStateCd=세팅
      -> SurveyController::getSurveyDetail => surveyRegist.jsp
      -> /survey/detailinfo (surveyRegist.jsp 초기 호출)
      -> ★ SurveyController::getSurveyDetailInfo
         -> ★★ SurveyMgmtService::getSurveyRcsInfo
         -> ★★ SurveyMgmtService::getSurveyRcsBtnInfo

## WEB 설문관리:설문취소 > 다운로드
SurveyController::getSurveyList => surveyList.jsp
URI: /survey/surveyDownload?surveySeq=
SurveyController::surveyDownload

## WEB 리포트 > 마케팅비즈챗 > 설문통계
1. 리스트
StatisticsController::main => statisticsMainSv.jsp
   -> ::mainSvProc
      -> StatisticsService::searchCustomSpcNumListByStat
         -> ...
         -> StatisticsSvService::searchDataOfDetail
            -> 
2. 상세
StatisticsController::surveyDayHist => statisticsDetailSurveyDayHist.jsp
   -> StatisticsSvService::searchDataOfDetailDay
3. 엑셀다운
StatisticsController::surveyDayHistListByExcel
   -> StatisticsSvService::getSearchDataOfDetailDay
      -> 
## WEB 리포트 > 마케팅비즈챗 > 설문통계 > 팝업
StatisticsController::surveyHist


# 비즈챗 어드민 Admin 분석
## 설문승인(화면: 관리자->설문승인)
### 화면동작
uri:survey/reqlist -> 화면: 설문승인 -> surveyReqList.jsp -> 설문상태: REGISTER
   -> [승인]
      -> 타게팅이 있을때 처리
         -> 팝업이 뜬다. (승인이 비활성화 되어 있다.)
      -> 타게팅 없을때 처리
         -> /survey/updateState -> 설문상태: APPR
   -> [반려]

DB:SURVEY(TGT_CND_USE_YN) 
   => 화면:타게팅이 Y 인경우 
      => 설문:승인 => 팝업
         => 광고 수신자 동의 대사 제외 : Y
            설문상태: APPR 처리
         => 광고 수신자 동의 대사 제외 : N
            설문상태: PRE_CHECK
   => 화면:타게팅이 N 인경우
      => 설문상태: APPR 처리

SurveyMgmtService::updateTargetingSurvey
   -> ::getSurveyCanNextTime

booking(Y: 자동대사, M: 수동대사)
가중치(20%=1.2) / 

### 설문이력 사이클
1. Admin 에서 [승인]할 경우 최초 저장된다. (SurveyMapper::insertSurveyStateHistory)
2. ...ing

### 소스동작 (ADMIN)
1. [X] 대시보드
- https://172.21.87.26:8200/dashboard => dashboard.jsp
DashboardController::dashboard
   -> CommonCodeService::searchCodeListByCdGrpId
      -> CodeMapper::selectCodeListByCdGrpId
         -> ★★DB: 코드조회 (LMS, MMS) 취득 <= RCS_LMS, RCS_MMS추가해야함
            -> SELECT(COM_CD)
   -> StatisticsService::searchDataDashboardOfAdmin
      -> StatisticsMapper::selectDataDashboardOfAdmin
         -> ★★DB: 통계 조회 <= RCS관련 코드 추가 (STAT_DAYS 통계에서 RCS 통계를 하도록 되어 있다.)
            -> SELECT(STAT_DAYS, CUSTOM, COM_CD) => STAT_DAYS 통계테이블

2. [X] 메시지관리&통계 > 마케팅비즈챗 > 전송완료메시지조회 (기:75p) (고객사: skp 선택)
- https://172.21.87.26:8200/notiMate/completeList => mtSndHistList.jsp
MateController::completeList
   -> MateService::selectDealerListByRlcId
      -> UserInfoMapper::selectDealerListByRlcId
         -> DB: 고객조회(딜러)
            -> SELECT(DLC)
   -> RLC? (고객조회)
      -> MateService::searchCustomUserPageListOfRlc
         -> UserInfoMapper::selectCustomUserListOfRlc
            -> DB: 사용자조회
               -> SELECT(SYSTEM_USER)
      -> MateService::searchCustomUserPageList
         -> UserInfoMapper::selectCustomUserList
            -> DB: 사용자조회
               -> SELECT(SYSTEM_USER)
   -> MateService::searchMtSndHistPageListByElastic
      -> ★::setElasticSearchParams (TODO: Elastic 조사해야함. 여기 유매니저한테 질문을 던져야 할듯)
         => Elastic은 MT_SND_HIST와 연동이 되어 있다고 한다. MSG_TP에 RCS관련이 있다면 조회가 될 것이다.
      -> ★ ElasticSearchApi::callElasticApi
         -> Elastic: 조회        
      -> ★::setElasticResponseList
         -> Elastic으로 결과 리스트 작성한다. 
   -> ERROR
      -> MateService::searchMtSndHistPageList
         -> ★ DB: 전송 카운트 조회 및 목록 조회
            -> SELECT(mt_snd_hist)

3. 메시지관리&통계 > 마케팅비즈챗 > MT 요청 메시지 조회 (기:78p)
- https://172.21.87.26:8200/notiMate/mtList => mtMsgQueueList.jsp
MateController::mtList
   -> ... [전송완료..조회] 같은 처리
   -> MateService::searchMtMsgQueuePageList
      -> MateService::selectMtMsgQueuePageList
         -> ★ DB: MT전송 메시지 조회
            -> SELECT(mt_msg_queue) => RCS는 유형에 포함되어 있어야 한다.(RCS_LMS, RCS_MMS)

4. 메시지관리&통계 > 마케팅비즈챗 > 설문 이력 조회 (기:85p)
- https://172.21.87.26:8200/svMate/surveyHistList => surveyHistList.jsp
MateController::surveyHistList
   -> MateService::searchSurveyHistPageList
      -> SurveyHistMapper::selectSurveyHistPageList
         -> ★★★(수정함) DB: 설문 이력 조회 => RCS 카운트 되도록 수정해야함
            -> SELECT(survey_hist)

4-1. 메시지관리&통계 > 마케팅비즈챗 > 설문 이력 조회 > 설문이력 상세정보 (기:86p)
- https://172.21.87.26:8200/svMate/surveyHistDetail => surveyHistDetail.jsp
MateController::surveyHistDetail
   -> MateService::searchSurveyActionHistList
      -> SurveyHistMapper::selectSurveyActionHistList
         -> ★★★(수정함) DB: 설문이력 상세 조회 => RCS 조회가 되도록 수정
            -> SELECT(survey_hist/survey/mt_snd_hist/mo_snd_hist)

5. 메시지관리&통계 > 마케팅비즈챗 > 고객사 전체 통계(141p) => 팝업(실패내역 팝업 케이스)
- https://172.21.87.26:8200/stat/sv/all => statSvAll.jsp
StatisticsController::customsBySvAll
   -> ...
   -> ★ ::csAllSearchInitCommon => 화면에 표시되는 (SMS, LMS, MMS를 값 세팅)
      -> CommonCodeService::searchCodeListByCdGrpId
         -> CodeMapper::selectCodeListByCdGrpId
            -> ★★★ DB: MSG타입 조회
               -> SELECT(COM_CD)
   -> ★ StatisticsSvService::searchDataByCustomsAll
      -> StatisticsSvMapper::selectDataByCustomsAll
         -> DB: 전체 통계 조회
            -> SELECT(SURVEY_HIST, CUSTOM, SURVEY_PARTCPTN)
               -> ★★★ statisticsBySv.sqlmap.xml => selectStatSurveyHist 수정
   -> 결과(tableDataList)

5-1. 메시지관리&통계 > 마케팅비즈챗 > 고객사 전체 통계(141p) > 팝업(실패내역 팝업 케이스)
- /svMate/failCompleteList => popFailSndHistList.jsp
MateController::failCompleteList
   -> MateService::searchMtSndHistPageListByElastic
      => 예외발생
         -> MateService::searchMtSndHistPageList
            -> MtSndHistMapper::selectMtSndHistPageList
               -> mtSndHist.sqlmap.xml::selectMtSndHistPageList
                  -> DB: MT발송 이력 조회 -> SELECT(MT_SND_HIST)


6. 메시지관리&통계 > 마케팅비즈챗 > 고객사 비교 통계(141p) => ★★★확인함
- https://172.21.87.26:8200/stat/sv => statSv.jsp
StatisticsController::customs
   -> ::sv
      -> ★ ::csSearchInitCommon => 화면에 표시되는 (SMS, LMS, MMS를 값 세팅)
      -> StatisticsSvService::searchDataByCustoms
         -> StatisticsSvMapper::selectDataByCustoms
         -> StatisticsSvMapper::selectDataByCustomsAll
            -> DB: 비교 통계 조회
               -> SELECT(CUSTOM, SURVEY_HIST)
   -> 결과(tableDataList)

7. 메시지관리&통계 > 마케팅비즈챗 > 고객사별 상세 통계(144p) => ★ 미확인함
- https://172.21.87.26:8200/stat/sv/custom => statSvCustom.jsp
StatisticsController::custom
   -> ::svCustom
      -> StatisticsSvService::searchDataOfDetail
         -> StatisticsSvMapper::searchDataOfDetail
            -> ★ DB: 상세 통계 조회
               -> SELECT(SURVEY, SURVEY_PROJECT, SURVEY_HIST, SURVEY_PARTCPTN)
   -> 결과(tableDataList)

7-1. 메시지관리&통계 > 마케팅비즈챗 > 고객사별 상세 통계 > 상세내역
- https://172.21.87.26:8200/stat/sv/custom/detail => statSvCustomPaging.jsp => ★ 화면수정
StatisticsController::customByPaging
   -> ::svCustomDetail
      -> StatisticsSvService::searchDataOfDetailByPaging
         -> ::searchDataOfDetailByPaging
            -> StatisticsSvMapper::selectDataByDaysOfPaging
            -> StatisticsSvMapper::selectDataByDaysOfDealPaging
            -> StatisticsSvMapper::selectDataByWeeksOfPaging
            -> selectDataByWeeksOfTelecomsOfPaging
            -> selectDataByWeeksOfSpcNumsOfPaging
            -> selectDataByWeeksOfTelecomsSpcNumsOfPaging
            -> selectDataByWeeksOfDealPaging
            -> selectDataByMonthsOfPaging
            -> ...머 많다..
               -> ★ DB : 상세내역 조회
                  -> SELECT(CUSTOM, SURVEY_HIST, SURVEY, SURVEY_PARTCPTN)
   -> 결과(list) ==> ★★★ 수정해보았음

7-2. 메시지관리&통계 > 마케팅비즈챗 > 고객사별 상세 통계 > 설문 통계(설문 이력 조회)
- https://172.21.87.26:8200/stat/sv/surveyHist => statSvSurveyHistPaging.jsp (statSvSurveyCompleDayHistPaging.jsp ???)
StatisticsController::surveyHist
   -> StatisticsSvService::searchSurveyHistPageListByStat
      -> SurveyHistMapper::selectSurveyHistPageListByStat
         -> ★★★ DB: 설문 이력 조회
            -> SELECT(survey_hist)
   -> 결과(list)

8. 메시지관리&통계 > 마케팅비즈챗 > 딜러사별 통계(150p) => ★★★확인함
- https://172.21.87.26:8200/stat/sv/deal
StatisticsController::deal
   -> ::svDeal
      -> StatisticsSvService::searchDataByCustom
         -> StatisticsSvMapper::selectDataByCustom
         -> StatisticsSvMapper::selectDataOfSpcNumsByCustom
            -> ★ DB: 딜러사별 통계 조회
               -> SELECT(CUSTOM, SURVEY_PARTCPTN, SURVEY_HIST)
   -> 결과(tableDataList)

9. 서비스 관리 > CID관리 > CID조회 (207p) ==> ★★★ 확인
- https://172.21.87.26:8200/msgserver/list
MessageServerController::list
   -> MessageServerService::searchMessageServerPageList
      -> MessageServerInfoMapper::selectMessageServerPageList
         -> ★ DB: CID조회
            -> SELECT(msg_server_connect_info)
   -> 결과(list)

10. 서비스 관리 > CID관리 > CID등록 화면 (208p) ==> ★★★ 확인
- https://172.21.87.26:8200/msgserver/regist => msgserverDetail.jsp
MessageServerController::create
   
10. 서비스 관리 > CID관리 > CID등록 처리 ==> ★★★ 확인
- https://172.21.87.26:8200/msgserver/regist => msgserverDetail.jsp
MessageServerController::list
   -> MessageServerService::createMessageServerInfo
      -> MessageServerInfoMapper::insertMessageServerInfo
         -> ★ DB: 등록 처리
            -> INSERT(msg_server_connect_info)

11. 설문리스트(갱신)(231p) [설문상태 변경 => SURVEY:APPR] 
화면: 설문 리스트 (surveyReqList.jsp) -> 설문승인 동작
SurveyController::getSurveyReqlist
   -> ★★ SurveyMgmtService::searchSurveyRequestList
      -> ::getSurveyRequestList
         -> SurveyMapper::selectSurveyListOfAdmin
            -> SURVEY_STATE:REGISTER,REJECT -> DB: 설문 등록/반려 조회 -> SELECT(SURVEY/SYSTEM_USER/CUSTOM/SURVEY_PROJECT)

화면: 테스트발송
SurveyController::sndTestSurvey
   -> ★★ SurveyMgmtService::saveTestSurvey
      => 웹 테스트 발송과 마찬가지로 진행한다.

화면: 승인 -> 팝업(MDN지정쿠폰) -> 파일선택 -> 승인처리
   -> URI:/survey/calculateCount => surveyReqList.jsp
      -> SurveyController::calculateCount
         -> SurveyMgmtService::saveTargetingFile
            -> ::excelFileUpload -> 파일업로드: 타겟 엑셀 파일 -> FileUtil.transferTo -> FILE: 지정 파일 패스로 업로드
            -> ::readNumList -> 파일검증: 타겟 엑셀 파일 -> 포맷(SurveyTrgterAdinfoVO) -> return: dataList(MDN지정쿠폰정보)
            -> MDN지정 쿠폰 〇
               -> ::saveSurveyAgreAssignedCoupon
                  -> SurveyMapper::deleteSurveyAgreCoupon
                     -> DB: 설문에 쿠폰이 존재하면 삭제한다.(사용자가 업로드한 쿠폰 삭제) -> DELETE(SURVEY_AGRE_COUPON)
                  -> 루프처리
                     -> SurveyMapper::insertSurveyAgreAssignedCoupon
                        -> B: 설문에 쿠폰 저장. -> INSERT(SURVEY_AGRE_COUPON)
            -> MDN지정 쿠폰 X
               -> 쿠폰 카운트 존재 〇
                  -> 에러 (쿠폰코드 없음)
               -> 쿠폰 카운트 존재 X
                  -> 타게팅 수신자 〇
                     -> 쿠폰파일 존재 〇
                        -> SurveyMapper::getAgreCouponCount
                           -> DB: 쿠폰 카운트 조회 -> SELECT(SURVEY_AGRE_COUPON)
                           -> 랜덤카운트 지정 (randomCouponCount) 
            -> 루프처리
               -> SurveyMapper::insertSurveyTempTarget
                  -> DB: -> INSERT(SURVEY_TEMP_TRGTER)
            -> SurveyAsynService::saveSurveyTargetAddInfo
               -> 루프처리
                  -> SurveyMapper::insertSurveyTargetAddInfo
                     -> DB: -> INSERT(SURVEY_TRGTER_ADINFO)
            -> SurveyMapper::compareSurveyTargetReject
               -> DB: 수신거부처리 -> UPDATE(SURVEY_TEMP_TRGTER)
            -> ...ing

화면: 승인처리
SurveyController::updateState (설문상태: RUNNING => APPR)
   -> SurveyMgmtService::updateSurveyState
      -> 수신자 번호 파일(등록시 입력) 있다. (타겟팅 수신자 X, 수신자 번호 O)
         -> SurveyMgmtService::updateTargetingSurvey
            -> 정보광고 수신 동의 대사 제외 (승인시 처리 기본 N 동의 아니다.) 이면서 수동(M:등록시)발송이 아닌경우 (수동발송 요청 X)
               -> 스케쥴 처리
            -> 정보광고 수신 동의 대사 제외 (CheckingExcept: Y)
               -> SurveyCode.SurveyStateCd.APPR -> 설문상태: APPR
            -> 제외가 아니면 대사 배치 수행 (CheckingExcept: N)
               -> SurveyCode.SurveyStateCd.PRE_CHECK -> 설문상태: PRE_CHECK
            -> DB: deleteSurveyTarget, moveSurveyTarget, updateSurveyForTarget, insertSurveyStateHistory
      -> 수신자 번호 파일(등록시 입력) 없으면
         -> SURVEY:APPR => 설문상태: APPR
            -> SurveyMapper::updateSurveyState -> DB: 설문상태 갱싱 -> UPDATE(SURVEY)
            -> ★ SurveyMapper::insertSurveyStateHistory -> DB: 설문 이력 저장 -> INSERT(SURVEY_STATE_UPD_HIST)
      -> 메일 보내기 (★ 메일 타이틀 작성시 RCS는 별도로 하는가?)
         -> SurveyMgmtService::saveMail
            => mail.message.xml
            => 초기화: SpringAdminConfig.java

20. WEB
리포트 > 마케팅비즈챗 > 설문통계

StatisticsController::main => statisticsMainSv.jsp
   -> StatisticsController::detailPagingListBySv => statisticsDetailPagingListSv.jsp
      -> 

# 스케쥴러 분석(mmate-survey-agent)
## 초기실행
BootStrap::start ->
   SenderApplicationConfig
      -> BEAN: MessageSource
      -> BEAN: ThreadPoolTaskScheduler
      -> ★ BEAN: SchedulerSendMsgSearchTask
      -> BEAN: SchedulerMoveTask

### 10분 (설문상태: APPR조회 => RUNNING변경 => SND_MSG:LMS/MMS/RCS별 생성)
agent.properties.xml::scheduler.check.survey
SchedulerStartSurveyTask::startSurvey
   -> SurveyService::startSurvey
      -> SurveyMapper::selectSurveyForScheduler -> 설문상태: APPR -> DB: 설문상태(APPR) 조회 -> SELECT(SURVEY)
         => ★★ 여기서 설문조회 할때 START TIME 현재시간보다 같거나 작은것들에 대해서 조회한다.
         -> 루프처리(APPR리스트)
            -> ★★::startSurvey(SurveySeq별로 루프)
               -> 설문 정보
                  -> SurveyMapper::selectSurvey -> DB: 설문조회 -> SELECT(SURVEY)
               -> 동시간대 진행중인 설문중 중복 MDN 처리
                  -> SurveyMapper::updateSurveyDupTrgter -> 설문상태: RUNNING -> DB: 설문상태 갱신 -> UPDATE(SURVEY_TRGTER) 
               -> 발송대상자
                  -> SurveyMapper::selectSurveyTrgter -> DB: 대상자 조회 -> SELECT(SURVEY_TRGTER)
               -> 고객특번확인
                  -> getCustomSpcNumList
               -> 비즈챗 사용확인
                  -> getCustomSvcList
               -> ★ 루프처리 (SURVEY1개당 수신받을 SND_MSG들을 등록)
                  -> ★ 이미지PATH 없음(SurveyVO::SurveyAgreImgFilePath => 코폰이미지)
                     -> SMS/LMS 처리
                  -> ★ 이미지PATH 있음
                     -> MMS 처리
                  -> ★★ RCS도 함께 처리 => MMS/LMS 일반과 RCS도 SND_MSG에 넣도록 한다.
               -> ★ SenderService::createSndMsgBatch
                  -> ★★ SenderMapper::insertSndMsgBatch -> DB: 메시지 저장 -> INSERT(SND_MSG(SURVEY_SEQ포함)=> MSG_TP (SMS/LMS/MMS)) => ★RCS용도로 SND_MSG에 관련내용을 포함하도록 한다.
               -> 설문동의 이미지가 있으면 (RCS 이미지는 maaperUrl로 대신한다.)
                  -> SenderService::selectMsgSeqListBySurveySeq -> DB: MSG_SEQ 가져오기 -> SELECT(SND_MSG)
                  -> ★ SenderService::createSndAttrFileBatch (첨부이미지 저장처리)
                     -> ★ SenderMapper::insertSndAttrFileBatch -> DB: 이미지정보 저장 -> INSERT(SND_ATTFILE)
            -> 상태: RUNNING
            -> 상태: ERROR
            -> updateSurveyStateCd -> DB: 설문상태 RUNNING/ERROR 갱신 -> UPDATE(SURVEY)
   
### 3초 (설문상태: RUNNING조회 -> MQ:WAIT:REQUEST:PUSH => MT_MSG_QUEUE:WAIT / SND_MSG:WAIT 별로 송신)
쿠폰상태=> NOISS : 미발급,  ISSUE : 발급,  REISS : 재발급, TSISS : 테스트 발급
★★ SchedulerSendMsgSearchTask
   -> ::sendLms
   -> ::sendSms
   -> ★ ::sendMms
      -> SurveyService::getSurveyByStateAndDate
         -> DB: 설문 RUNNING 상태 조회 -> SELECT(SURVEY)
      -> SenderService::searchListSendMsgForMms => SND_MSG:INS 상태 조회
         -> DB: 메시지 내용 조회 -> SELECT(SND_MSG:상태:INS) -> SND_MSG 에서 MMS이고, SURVEY_SEQ인 리스트 취득
      -> 루프처리(설문상태:running 개수만큼 )
         -> SenderService::searchListSendMsgForMms -> SURVEY_SEQ당 SND_MSG 리스트 취득
            -> ★★ SenderService::modifyListSndStepStateToReqIng 
               -> SND_MSG(SND_STEP_STATE:REQING, UPD_USER_ID:URI_MMS) -> SND_MSG 상태갱신 
                  => ★★ TODO: RCS인경우 UPD_USER_ID는 어떻게 해야 하나
            -> 루프처리 (SND_MSG 리스트 만큼)
               -> 대기큐 처리 (★ 중요)
               -> 루프처리 (대기큐 성공까지)
                  -> MtMessageService::saveSendMessage
                     -> ★ 많은일을 한다.
                     -> 키워드&쿠폰있으면
                        -> ★ SurveyService::getAgreGuideReMsgWithAgreCoupon => 쿠폰 발급 및 치환처리
                           -> SurveyMapper::selectSurveyAgreCouponInfo
                              -> DB: 설문동의 쿠폰 조회 -> SELECT(SURVEY_AGRE_COUPON)
                           -> 쿠폰있으면
                              -> 테스트이면
                                 -> SurveyMapper::selectIssuedSurveyAgreCouponInfo
                                    -> DB: 설문동의 쿠폰 조회('ISSUE', 'REISS', 'TSISS') -> SELECT(SURVEY_AGRE_COUPON)
                              -> SurveyMapper::updateSurveyAgreCouponInfo
                                 -> DB: 설문동의 쿠폰 갱신 -> STATE:REISS -> UPDATE(SURVEY_AGRE_COUPON)
                           -> 쿠폰없으면
                              -> 테스트이면
                                 => STATE:TSISS
                              -> 테스트아니면
                                 => STATE:ISSUE
                              -> SurveyMapper::updateIssuedSurveyAgreCouponInfo
                                 -> DB: 설문동의 쿠폰 상태 갱싱 -> STATE:NOISS => STATE:(ISSUE, TSISS) -> UPDATE(SURVEY_AGRE_COUPON)
                              -> 상태갱신 설문 1개이상
                                 -> 테스트 쿠폰 상태 갱신
                           -> 동의 내용에 "[코드삽입]" 을 쿠폰코드로 치환처리
                           -> 최종 치환된 동의내용을 리턴
                        -> 쿠폰코드 소진이면 메시지 발송 안함.
                           -> SND_MSG(SND_STEP_STATE:REQCANCEL) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)
                     -> MtMsgQueueVO(CustomReqId=SndMsg:MSG_SEQ 포함)
                     -> ::createMtMsgQueue(MtSndReqVO, MtMsgQueueVO, MtMsgQueueBinVO)
                        -> DB: 정보입력 -> INSERT(MT_SND_REQ)
                        -> DB: 정보입력 -> INSERT(★ MT_MSG_QUEUE)
                        -> DB: 이미지 정보입력 -> INSERT(MT_MSG_QUEUE_BIN)
                     -> ★ MessageQueueSender::sendMtMgrRequest(MtMessage) -> MessageStatus.WAIT -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH
                     -> SND_MSG(SND_STEP_STATE:WAIT) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)
                  -> 예외 발생
                     -> SND_MSG(SND_STEP_STATE:REQFAIL) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)
   -> ★★ ::sendRcs


### 수신부분 ...ing
SurveyService::sendAnsErrNotiMsg
SurveyService::sendSurveyCoupon -> sendMsg
ReceiveMsgHandler::sendSurvey -> SurveyService::sendSurveyCoupon
ReceiveMsgHandler::sendSurvey -> SurveyService::sendSurveyQuestion
   -> createSndMsg ->insertSndMsg -> DB: 메시지 저장 -> INSERT(SND_MSG)

# MQ매니저 mmate-mt-mgr 분석
MSG_REQUEST 
0. 초기시작
Bootstrap::start
   -> ★ spring.profiles.active = mt_mgr

9. MMS 전송 결과 MQ Push (MQ:MT_MGR_REQUEST)
MtMgrRequestQueueListener::onMessage 
   -> MtMgrService::searchMtMsgQueueInfo
      -> MtMapper::selectMtMsgQueueInfoWithChargeCheckView
         -> DB: 조회 -> SELECT(MT_MSG_QUEUE[userid, mtqueueid])
   -> DeviceCacheService::findDeviceInfo
      -> CACHE: 조회 -> JPA(device)
   -> MtMgrService::modifyMtMsgQueue -> MessageStatus.REQ or FAIL -> QUEUE상태 갱신
      -> DB: 갱신 -> UPDATE(MT_MSG_QUEUE)
   -> 성공여부 
      -> 실패 -> MtMgrService::sendMtMgrReultByFinalFail
                  -> MtMgrResultSenderByFinalFail::sendMtMgrResult -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
      -> 성공
         -> SKT아닌경우(AGENT를 통해 발송)
            -> RlcAgentService::saveInfoBackMtMessage
         -> SKT경우
            -> MtMgrService::sendMsgReq (메시지별 직접 통신사 송신)
               -> SMS:MtSmsSender::sendMtSmsSktRequest -> MQ:PUSH
               -> LMS:MtMmsSender::sendMtMmsSktRequest -> MQ:PUSH
               -> MMS:MtMmsSender::sendMtMmsSktRequest -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH

# MMS client (발송기)
MmsSktClient::toSubmit -> SktDeliverySubmit -> 최종 딜리버리용 객체를 만든다.이것을 이용하여 RCS도 이용하도록 한다.
MtMsgQueueVO 클래스와 MtMsgQueueVO용도의 DB스키마를 RCS용을 추가하면 어떨까 싶다.
* MMS같은 경우 MtMsgQueue를 MtMsgQueueInfo에 파일과 컨텐츠를 담아서 클라이언트에 전송을 한다.
MmsSendManager::sendMessage ->  MmsSktClient::sendMessage(MtMsgQueueInfo)
* RCS라면 위와 비슷하게 처리하도록 고민해보자..

## MT_MSG_QUEUE 상태
- WAIT 신청상태
- REQ
- PROC
- CMPL
- FAIL
- RETRY

## MQ 용도
MT_MGR_RESULT: 실패처리

## MMS-Client 발송
1. MQ:MT_MMS_SKT에서 메시지를 가져와서 전송 준비(메시지 복호화 처리 -> 파일정보 -> 발송 큐에 적재)
MmsSktQueueListener::onMessage
   -> QueueName.MT_MMS.MT_MMS_SKT 
      -> ::findMtMsgQueue
         -> LMS, MMS가 아닌경우 return
         -> MmsMtMessageService::findMtMessageQueue
            -> MtMapper::selectMtMsg
               -> DB : 조회 -> SELECT(MT_MSG_QUEUE[mtqueueid])
            -> 메시지 타이틀/내용 => 복호화 처리후 다시 저장
      -> ReTry 횟수 넘은경우 (RETRY MAX:3)
         -> ::processFailResult
            -> MmsMtMessageService::modifyMtMessageQueue
               -> MtMapper::updateMtMsgQueue => 실패
                  -> MSG_QUEUE:FAIL -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
            -> MmsSktQueueSender::sendMtMgrResult
               -> MT_MESSAGE:FAIL -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
      -> RclID 존재 X 
         -> CustomerService::findCustomerDetail
            -> CustomerManageMapper::selectCustomerDetail
               -> DB: RclID(고객) 조회 -> SELECT(CUSTOM)
            -> 고객존재 X
               -> ::processFailResult
                  -> MmsMtMessageService::modifyMtMessageQueue
                     -> MtMapper::updateMtMsgQueue => 실패
                        -> MSG_QUEUE:FAIL -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                  -> MmsSktQueueSender::sendMtMgrResult
                     -> MT_MESSAGE:FAIL -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
      -> RclID 존재 O => 단말기 발송처리!!!
         -> MmsSendManager::sendMessage
            -> MmsMtMessageService::searchMtMessageQueueFileList
               -> MmsMtMessageService::selectMtMsgQueueBinList
                  -> DB: 단말기 MMS 첨부파일 조회 -> SELECT(MT_MSG_QUEUE_BIN)
            -> MmsSktClient::sendMessage -> queue:put

2. 발송처리 (발송 큐에서 메시지 취득후 발송후 단말로 부터 Submit RES 메시지 받는다. (발송에 대한 결과값이 반환이 아니다.))
MmsSktClient::run 
   -> 연결이 끊어져있다면
      -> ::sendReMessageQueue
         -> Queue의 모든 메시지에 대해서 RETRY처리 -> MessageStatus.RETRY -> MmsSktQueueSender::sendMtMgrRequest
   -> 연결되어 있다면
      -> ::queue::poll 
         -> CommonCode.MessageStatus.REQ 
            -> MmsMtMessageService::modifyMtMessageQueue
               -> MSG_QUEUE:REQ -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
            -> ::sendMessage (실제 전송처리!!!)
               -> SktDeliverySubmit::toByte (메시지 전체 바이트 변환 - SOAP형태) -> 파일 전문 처리 -> 전체적으로 SOAP처리 -> 전체 byte변환
                  -> MmsUtils::readFile (이미지 byte)
               -> OutputStream::write 
               ...ing...
               -> 최종 file에 대한 [덤프처리여부 => 덤프파일위치]덤프처리
               -> disconnect -> 연결끊음
            -> ★::callBackResult (발송후 처리)
               -> result.isSuccess 성공
                  -> MmsMtMessageService::saveMtMessageQueue
                     -> MtMapper::updateMtMsgQueue
                        -> MSG_QUEUE:REQ -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                     -> MtMapper::insertMtMsgQueueActionHist
                        -> Q_HISTORY:SUCC -> DB: 메시지 큐 이력 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
               -> result.isUseRetry 재발송
                  -> MmsMtMessageService::saveMtMessageQueue
                     -> MtMapper::updateMtMsgQueue
                        -> MSG_QUEUE:RETRY -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                     -> MtMapper::insertMtMsgQueueActionHist
                        -> Q_HISTORY:FAIL -> DB: 메시지 큐 이력 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                  -> MmsSktQueueSender::sendRetryMtMmsSkt
                     -> MT_MESSAGE:RETRY -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH
               -> result.isNoConnection 연결실패
                  -> MmsMtMessageService::modifyMtMessageQueue
                     -> MtMapper::updateMtMsgQueue
                        -> MSG_QUEUE:REQ -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                  -> MmsSktQueueSender::sendRetryMtMmsSkt
                     -> MT_MESSAGE:RETRY -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH
               -> 그외처리 => 실패 전송 처리 (★★ 전화번호가 안맞거나, RCS를 받을수 없는 단말인경우)
                  -> MmsMtMessageService::saveMtMessageQueue (Fail처리: MT_MSG_QUEUE/MT_MSG_QUEUE_ACTION_HIST)
                     -> MtMapper::updateMtMsgQueue
                        -> MSG_QUEUE:FAIL -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                     -> MtMapper::insertMtMsgQueueActionHist
                        -> Q_HISTORY:FAIL -> DB: 메시지 큐 이력 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                  -> MmsSktQueueSender::sendMtMgrResult
                     -> MT_MESSAGE:FAIL -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
            -> 상담처리...
            -> 끝
      -> 예외발생
         -> MmsMtMessageService::modifyMtMessageQueue
            -> MSG_QUEUE:WAIT -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
         -> MmsSktQueueSender::sendMtMgrRequest
            -> MT_MESSAGE:RETRY -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH

## MMS Client 발송결과 수신(MMS) => MQ:MT_MGR_RESULT
- MMS 결과 수신 2군데이다. 
   - MSG를 송신에 대한 결과
   - 정상적인 처리후의 delivery_report 로 결과를 전송하는 경우

### delivery_report로 결과 수신 (MT_MSG_QUEUE:CMPL처리한다.)
/mms/mt/skt/delivery_report
SktDeliveryReportController::deliveryReportReq
   -> MmsSktReportService::saveDeliveryReport
      -> MmsMtMessageService::findMtMessageQueueByMsgId
         -> MtMapper::selectMtMsgQueueByMsgIdAndActionHist
            -> DB: MT_MSG_QUEUE VO 조회 -> SELECT(mt_msg_queue)
      -> MmsMtMessageService::findLastMtMsgQueueActionHist
         -> MtMapper::selectMtMsgQueueActionHistList
            -> DB: MT_MSG_QUEUE_ACTION_HIST 조회 -> SELECT(mt_msg_queue_action_hist)
      -> 성공 〇
         -> 상태변경:MT_MSG_QUEUE:CMPL
         -> 상태변경:MT_MSG_QUEUE_ACTION_HIST:SUCC
         -> MmsMtMessageService::saveMtMessageQueue
            -> MtMapper::updateMtMsgQueue
               -> DB: 상태갱신:CMPL -> UPDATE(MT_MSG_QUEUE)
            -> MtMapper::insertMtMsgQueueActionHist
               -> DB: 히스토리 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
      -> 전화번호 바뀜
         -> 상태변경:MT_MSG_QUEUE:RETRY
         -> 상태변경:MT_MSG_QUEUE_ACTION_HIST:FAIL
         -> MmsMtMessageService::saveMtMessageQueue
            -> MtMapper::updateMtMsgQueue
               -> DB: 상태갱신:CMPL -> UPDATE(MT_MSG_QUEUE)
            -> MtMapper::insertMtMsgQueueActionHist
               -> DB: 히스토리 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
      -> 재시도
         -> 상태변경:MT_MSG_QUEUE:RETRY
         -> 상태변경:MT_MSG_QUEUE_ACTION_HIST:FAIL
         -> MmsMtMessageService::saveMtMessageQueue
            -> MtMapper::updateMtMsgQueue
               -> DB: 상태갱신:CMPL -> UPDATE(MT_MSG_QUEUE)
            -> MtMapper::insertMtMsgQueueActionHist
               -> DB: 히스토리 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
      -> 그외
         -> 상태변경:MT_MSG_QUEUE:FAIL
         -> 상태변경:MT_MSG_QUEUE_ACTION_HIST:FAIL
         -> MmsMtMessageService::saveMtMessageQueue
            -> MtMapper::updateMtMsgQueue
               -> DB: 상태갱신:CMPL -> UPDATE(MT_MSG_QUEUE)
            -> MtMapper::insertMtMsgQueueActionHist
               -> DB: 히스토리 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
   -> 성공 〇
      -> 상태변경:MT_MSG:CMPL
      -> MmsSktQueueSender::sendMtMgrResult -> MQ:MT_MGR_RESULT -> MQ:PUSH => 
   -> ...ing
   
# ★★ 배치
## 기동
user:mateserver
path:/app/mateserver
scheduler: crontab -l

## 배치 초기화 (SELECT FOR UPDATE 조건에 따라 배치 처리 여부가 결정된다. 참고용)
SchedulerExecuteInterceptor => @scheduled에 대해서 Aspect하게된다.
   -> BatchExecHistService::executeBatchExecHist
      -> batchExecHist.sqlmap.xml::selectExisBatchExecHistInfo

## MT 발송 이력 저장 (테이블: MT_SND_HIST : 발송 이력은 MT_SND_HIST에 저장하고 MT_MSG_QUEUE는 삭제처리한다.)
- 결국 메시지 발송 최종적으로는 MT_MSG_QUEUE(CMPL,FAIL) 상태인것은 배치를 통해서 history 테이블로 이관이 된다. API에서 어떤 처리가 있을줄알았는데 없더라....
- xml: batch2 ::batch.job.MtSendReqToMoveJob.xml
Bootstrap::executeMtSendReqToMoveJob
JobExecutor::executeMtSendReqToMoveJob
   -> executeBatchJob(mtSendReqToMoveJob) => Job정의 => batch.job.MtSendReqToMoveJob.xml
      -> Job::mtSendReqToMoveReader
         -> DB: 상태:CMPL/FAIL 조회 -> SELECT(MT_MSG_QUEUE)
      -> MtSendReqToMoveWriter::write
         -> MtService::saveMtSendReqToMove
            -> MtSndHistMapper::insertMtSndHist
               -> DB: 발송 히스토리 저장 -> INSERT(MT_SND_HIST)
            -> MtSndHistMapper::insertMtSndActionHistList
               -> DB: 발송 행위 히스토리 저장 -> INSERT(MT_SND_ACTION_HIST)
            -> MtMapper::deleteMtMsgQueueActionHist
               -> DB: MT_MSG_QUEUE_ACTION_HIST 삭제 -> DELETE(MT_MSG_QUEUE_ACTION_HIST)
            -> MtMapper::deleteMtMsgQueue
               -> DB: MT_MSG_QUEUE 삭제 -> DELETE(MT_MSG_QUEUE)
            -> MMS 인가 〇 => 첨부파일 삭제 처리
               -> MtMapper::selectMtMsgQueueBinFilePathList
                  -> DB: 첨부파일 조회 -> SELECT(MT_MSG_QUEUE_BIN)
               -> MtMapper::deleteMtMsgQueueBin
                  -> DB: 첨부파일 삭제 -> DELETE(MT_MSG_QUEUE_BIN)

## 마케팅 통계 (테이블: STAT_HOURS/STAT_DAYS)
Bootstrap::executeStatisticsMarketJob
   -> JobExecutor::executeStatisticsMarketJob
      -> executeBatchJob(statisticsMarketJob) => Job정의 => batch.job.statisticsJob.xml
         -> HOUR: StatisticsHoursWriter::write
            -> StatisticsService::createStatHoursBatch
               -> StatisticsMapper::deleteStatHoursBatch
                  -> DB: 통계 삭제 -> DELETE(STAT_HOURS)
               -> StatisticsMapper::insertStatHoursBatch
                  -> DB: 통계 저장 -> INSERT(STATE_HOURS (SELECT: MT_SND_HIST/MO_RCV_HIST))
         -> DAY: StatisticsDaysWriter::write
            -> StatisticsService::createStatDaysBatch
               -> StatisticsMapper::deleteStatDaysBatch
                  -> DB: 통계 삭제 -> DELETE(STAT_DAYS)
               -> StatisticsMapper::insertStatDaysBatch
                  -> DB: 통계 저장 -> INSERT(STAT_DAYS (SELECT: MT_SND_HIST/MO_RCV_HIST))
         -> 모바일 집계 처리 HOUR ...
         -> 모바일 집계 처리 DAY ...

## 설문결과 삭제(Job: surveyResultJob) => 이건 주석처리가 되어있다. !!!!!
JobExecutor::executeSurveyResultJob
   -> Job: surveyResultJob
      => batch.job.surveyResultJob.xml::surveyResultJob
         -> surveyResultReader
            -> DB: 설문/설문 테스트 조회 -> SELECT(SURVEY)
         -> surveyResultWriter
            -> 설문조회 내용 삭제 -> DELETE(SURVEY)

## 설문이력 통계(Job: surveyHistJob, 테이블: SURVEY_HIST 집계처리를 한다.★★)
JobExecutor::executeSurveyResultJob
   -> Job: surveyHistJob
      => batch.job.surveyHistJob.xml::surveyHistJob
         -> surveyTargetReader
            -> DB: 설문조회(RUNNING, AUTO_END, MANUAL_END) -> SELECT(SURVEY)
         -> surveyHistWriter
            -> SurveyHistService::saveSurveyHistBatch
               -> SurveyHistMapper::updateSurveyHistBatch
                  -> ★★★(수정함) DB: SURVEY_HISTORY -> INSERT(SURVEY_HIST) => 쿼리에 RCS도 반영해야 한다. => 반영함

## 설문 히스토리
ReceiveMsgHandler::channelRead0
=> surveyHist.sqlmap::insertSurveyHist

# MT MGR
## MQ:MT_MGR_RESULT (결과 => OpenAPI 전달) => 거의 실패건에 대한것이다.
MtMgrResultQueueListener::onMessage
   -> MtMgrService::searchOpenApiSendResultNotification
      -> MtMapper::selectOpenApiSendResultNotification => 전송결과 조회(결과 입력은 API에서 한다. [수신프로세스]참조)
         -> DB: 전송 결과 조회(성공,실패) -> SELECT(MT_MSG_QUEUE(CMPL,FAIL) union MT_SND_HIST(CMPL,FAIL))
   -> MtMgrService::modifyMtMgrResult
   -> MSG상태:CMPL 〇
      -> DeviceCacheService::saveDeviceInfo
         -> 캐시 저장
   -> MtMgrService::sendCallback => 최종결과 OpenAPI 전달
      -> ApiCallBackSender::sendApiCallBackRequest
         -> QueueName.API.API_CALLBACK -> MQ:PUSH

# API
## MQ:API_CALLBACK
ApiCallbackQueueListener::onMessageApiCallBack
   -> ::onMessageCommon
      -> MtSendReqService::searchOpenApiSendResultNotification
         -> MtMapper::selectOpenApiSendResultNotification
            -> DB: 결과 조회 상태:CMPL/FAIL -> SELECT(MT_MSG_QUEUE)
      -> Executor 초기 처리 (notiURL: http://172.21.107.110:8100/mt)
         => survey-agent => ReceiveMsgHandler::channelRead0
- MMS 전송결과 Notification 응답코드 저장(DB)
AsynCustomerCallbackSender::run()
   -> CloseableHttpClient::execute
      -> ★ API_IP/mt => survey-agent쪽으로 요청이다 => ReceiveMsgHandler::channelRead0 => [SURVEY AGENT > 수신 처리] 처리 참조
      ... ing
      -> Y
         -> MtSendReqService::saveCustomNotificationResultToHistory
            -> MtSndHistMapper::updateMtSndHist
               -> DB: 히스토리 갱신 -> UPDATE(MT_SND_HIST)
            -> MtSndHistMapper::insertMtSndActionHist
               -> 성공/실패 (ProcessResult.SUCC/ProcessResult.FAIL)
                  -> DB: 히스토리 저장 -> INSERT(MT_SND_ACTION_HIST)

      -> N ★★ (히스토리에 저장후 MT_MSG_QUEUE를 삭제처리한다.)
         -> MtSendReqService::saveCustomNotificationResult
            -> MtMapper::updateMtMsgQueue
               -> DB: 큐정보 -> UPDATE(MT_MSG_QUEUE)
            -> MtMapper::insertMtMsgQueueActionHist
               -> 성공/실패 (ProcessResult.SUCC/ProcessResult.FAIL)
               -> DB: 히스토리 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
            -> CustomSend 성공
               -> MtSndHistMapper::insertMtSndHist
                  -> DB: 히스토리 저장 -> INSERT(MT_SND_HIST)
               -> MtSndHistMapper::insertMtSndHist
                  -> DB: 히스토리 저장 -> INSERT(MT_SND_ACTION_HIST)
               -> MtMapper::deleteMtMsgQueueActionHist
                  -> DB: 큐 히스토리 삭제 -> DELETE(MT_MSG_QUEUE_ACTION_HIST)
               -> MtMapper::deleteMtMsgQueue
                  -> DB: 메시지큐 정보 삭제 -> DELETE(MT_MSG_QUEUE)
               -> MMS인경우 첨부파일 삭제
                  -> MtMapper::selectMtMsgQueueBinFilePathList
                     -> DB: 첨부파일 경로 리스트 조회 -> SELECT(MT_MSG_QUEUE_BIN)
                  -> MtMapper::deleteMtMsgQueueBin
                     -> DB: 첨부파일 삭제 -> DELETE(MT_MSG_QUEUE_BIN)
   -> 실패
         -> RetrySender::sendApiCallbackRetry -> QueueName.API.API_CALLBACK_RETRY

# SURVEY AGENT
## 수신 처리 (OpenAPI => Survey-Agent)
ReceiveMsgHandler::channelRead0
   -> ... 여러 조건들이 있다.
   -> ReceiveUriCd.RCV_URI_FOR_MT => 발송완료처리:API로부터 받는 부분 같음
      -> ReceiverService::modifyMtRcvInfo
         -> RES_CODE:2000 => 성공
         -> RES_CODE:2000이 아니면 => 실패
         -> SND_MSG(SND_STEP_STATE:RESULT) -> CommonMapper::updateSndMsg -> DB: SND_MSG 상태갱신 -> UPDATE(SND_MSG)
         -> SND_MSG 갱신 카운트가 1개이상이면 SND_MSG 첨부파일 삭제
            -> CommonMapper::deleteSndAttFile -> DB: SND_ATTFILE 삭제 -> DELETE(SND_ATTFILE)
      -> 성공 (RES_CODE:2000)
         -> SenderService::getSendMsg
            -> SenderMapper::selectSendMsg
               -> DB: SND_MSG 조회 -> SELECT(SND_MSG)
         -> SurveyService::getLastSurveyHistory
            -> SurveyMapper::selectLastSurveyHistory
               -> DB: 설문응답 조회 -> SELECT(SURVEY_RES)
         -> 응답조회 NULL
            -> SurveyService::createSurveyJoinInfo
               -> DB: 설문참여 저장(설문 동의상태 저장) -> INSERT(SURVEY_PARTCPTN) 
            -> SurveyService::createSurveyResponse
               -> DB: 설문응답 저장(안내메시지결과 저장) -> INSERT(SURVEY_RES) 
            -> SurveyService::saveAgreCouponResult
               -> SurveyMapper::selectIssuedSurveyAgreCouponInfo
               -> 쿠폰코드 존재 〇
                  -> SurveyMapper::updateSurveyCouponResult
                     -> DB: 쿠폰 상태 갱신 -> 프로시저 사용 -> UPDATE(SURVEY_COUPON_RESULT)
            -> SurveyService::getSurveyTgtUseYn
               -> DB: 설문 타겟 유무 -> SELECT(SURVEY)
            -> 설문문항 존재 〇
               -> ::sendSurvey() => 첫번째 설문 문항 발송
            -> 설문문항 존재 X
               -> ★★★ SurveyService::insertSurveyHist => 설문이력 생성
                  -> ★★★ DB:SURVEY_HIST -> INSERT(SURVEY_HIST)
                     => ★★★(수정함) RCS도 INSERT하도록 한다.
               -> SurveyService::getFirstSurveyQuestion => 설문문항 조회
                  -> DB: 설문문항 조회 -> SELECT(SURVEY_QUST)
               -> 문항존재 〇 => 쿠폰 발송 처리
                  -> SurveyService::sendSurveyCoupon
                  -> ::sendMsgAPI
                  -> SurveyService::createSurveyAnalMtSucc => 인구통계
                     -> SurveyMapper::insertSurveyAnalResultMtSucc
                        -> DB: 인구통계 저장 -> INSERT(SURVEY_ANAL_RESULT)
               -> 문항존재 X
                  -> SurveyService::createSurveyAnalMtSucc => 인구통계
                  -> ::sendCompleteMsg => 
                  -> SurveyService::updateSurveyHistComplete => 히스토리 완료처리
                     -> SurveyMapper::updateSurveyHistComplete
                        -> DB:설문히스토리 갱신 -> UPDATE(SURVEY_HIST)
   -> sendResponse => 요청(HTTP)에 의한 응답을 보낸다.


# 설문 전체 라이프사이클 상태
등록 -> STAT:REGIST -> 타게팅 -> PRE_CHECK -> 승인 -> STAT:APPR -> 스케쥴:10분 -> STAT:RUNNING -> 스케쥴:3분 -> MSG_STAT:WAIT -> MQ:PUSH

* 관련테이블
SURVEY(과금유형:surveyMsgTp(기존: LMS, MMS/추가: RCS_LMS, RCS_MMS))
   - 파일경로
      RcverPhoneNumFileUrl
      RcvRjtPhoneNumFileUrl
      SurveyAgreImgFilePath
      SurveyComplImgFilePath
      AgreCouponCdFileUrl
      CouponCdFileUrl

SURVEY_TRGTER
SURVEY_RCV_RJTER
SURVEY_AGRE_COUPON
SURVEY_QUST (설문질문 이미지/쿠폰등등)
* 나스(파일)경로

## MMS발송 요청
AsyncTaskSender::senderForMms 
      -> agent.properties.xml(/v1/sendMms) 
      -> SenderService::selectListSendAttFile -> ★ DB: 첨부파일 조회 -> SELECT(SND_ATTFILE)
      -> ★ 전송데이터 작성후 HTTP요청 
         -> ★ CloseableHttpClient::execute

### 프렘웍분석
## 최초시작
WebApplicationInitializer 
    -> AbstractContextLoaderInitializer
        -> AbstractAnnotationConfigDispatcherServletInitializer
            -> WebApplicationConfig
               -> SpringRootConfig
               -> SpringWebDataSourceConfig
               -> SpringSecurityConfig
                  -> Bean: AuthenticationManager
                  -> Bean: AuthenticationProvider
                  -> Bean: FilterChainProxy
               -> SpringWebConfig
               

    -> AbstractSecurityWebApplicationInitializer
    -> JerseyWebApplicationInitializer
    -> SpringBootServletInitializer

SpringServletContainerInitializer::onStartup -> StandardContext.java::startInternal -> 

# mmate_web
# 분석
## 초기실행
WebApplicationConfig::
    -> XSSServletFilter::doFilterInternal
        -> CommonsMultipartResolver::isMultipart
            -> 이면
                -> CommonsMultipartResolver::resolveMultipart (* 파일업로드...관련)
            -> 아니면
                -> /survey/saveSurvey
                    -> 이면
                        -> XssRequestWrapperForSurvey::createRequest
                    -> 아니면
                        -> XssRequestWrapper::createRequest

0. 로컬 기동됨....
http://localhost:8080/mmate-web-local/main
1. 인증처리
SpringSecurityConfig::(순서: authenticate -> filter)
      => authenticationProvider
         -> UsernameAuthenticationProvider::authenticate 
            -> CustomerContactService::loadUserByUsername 
               => 성공 
                  -> SecurityContextHolder.getContext.setAuthentication
               => 실패
                  -> 각 로그인 실패별 예외처리 throw ①
                  -> CustomerContactService::modifyLoginFail (실패 카운트)
      => UsernamePasswordAuthenticationFilter
         => 성공
            -> LoginSuccessHandler
         => 실패
            -> onAuthenticationFailure
               -> ① 로그인 실패 예외를 받아서 session에 저장

2. 로그인 화면 표시
LoginController::login
..ing


## 프론트 잠깐 조사
1. JSP
- thymeleaf사용
2. 분석
프론트와 비지니스간 통신을 알아보기 위해 FAQ 등록에 관련하여 조사중....
테이블: FAQ 
JAVA: FaqController::registSave
JSP: faqRegist.jsp(faqId는 어디서 세팅되는지 찾는중...)
흐름: faq/list->faq/regist (여기서는 faqId를 hidden처리되어 있음)
INSERT쿼리 돌때마다 주키 시퀀스는 아래 설정된 sequence 쿼리를 이용한다.
```SQL
create sequence FAQ_SEQ start with 1 increment BY 1 maxvalue 999999999999999999;
```

### 조사
Message의 RlcID 는 무엇?

### 파일전성
1. properties::api.mms.attach.file.max 를 이용해서 파일 개수 설정