# 비지니스 분석

## 기존 프로젝트 분석
1. AsIs SMS전체 과정
2. AsIs MMS전체 과정

## 기술관련
1. RabbitMQTemplate 를 이용해서 Message송수신을 한다.
2. Listener는 SpringMessageQueueConfig에서 정의한다.

## 메시지 발송(MT/SMS)
0. RabbitMQListener/Template 생성
SpringMessageQueueConfig 에서 생성한다.

1. SMS 발송 요청(MQ발송 요청/DB요청 데이터 저장)
⓪ 메시지 타입
CommonCode::MessageSubType(SMS, LMS, MMS)
- SMS: /v1/sendSms
- LMS: /v1/sendLms
- MMS: /v1/sendMms

① (MT플로우 그림에서 6번까지이다)
MtController::sendSms->MtSendReqService::createMtSmsSndReq->MtMapper::insertMtSndReq->INSERT(MT_SND_REQ)
                                                          ->MtMapper::insertMtMsgQueue->INSERT(MT_MSG_QUEUE)
                     ->ApiSender::sendMtMgrRequest-> MessageStatus.WAIT -> MQ:PUSH
② (MT매니저-요청 플로우 그림 7번까지)
MtMgrRequestQueueListener::onMessage -> MessageStatus.REQ
                    -> MtMgrService::modifyMtMsgQueue(메시지 상태변경) -> UPDATE(MT_MSG_QUEUE)
                    -> RlcAgentService::saveInfoBackMtMessage (인포뱅크용 Agent 경유 => 사용안함)
                    -> MtMgrService::sendMsgReq (메시지별 직접 통신사 송신)
                        -> SMS:MtSmsSender::sendMtSmsSktRequest -> MQ:PUSH
                        -> LMS:MtMmsSender::sendMtMmsSktRequest -> MQ:PUSH
                        -> MMS:MtMmsSender::sendMtMmsSktRequest -> MQ:PUSH

②-1 (통신사 SMS클라이언트 수신)
...ing...
=> 시작
Bootstrap   -> Component스캔: Bootstrap::start -> SpringRootConfig 에서 수행(com.skt.mate.config)
            -> ApplicationEventListener::ApplicationListener<ContextClosedEvent> => ApplicationContext가 클로즈될때 호출된다.

SpringSmsSktConfig => @Configuration 에서 수행한다.(큐리스너, Netty핸들러, 프로시저등등)

=> MQ리스너 설정후 queue에 put
QueueListener: SmsSktQueueListener::onMessage -> 메시지 Retry 카운트 체크
                                            -> SmsSendManager::sendMessage -> SmsSktClient::sendMessage -> queue::put         

=> 루프에서 queue에서 poll
SmsSktClient::run -> ::queue::poll -> ::toSmsPayload 단말기에 보낼 전문을 생성한다.
                  -> channel::writeAndFlush 단말기로 송신[Netty:송신]
                  -> MessageStatus.RETRY 실패시
                    -> MQ:PUSH


=> 단말기 전송후 단말기로부터 수신 메시지 처리[Netty:수신]
SmsSktHandler::channelRead0 -> ResultRequestProcedure::process -> MessageStatus.CMPL/MessageStatus.RETRY/MessageStatus.FAIL
                            -> MessageStatus.CMPL -> SmsSktQueueSender::sendMtMgrResult -> MQ:PUSH(MT_MGR_RESULT) -> (MT매니저-수신플로우)

? RCS단말 결과값 코드가 어떻게 되는지 물어야함.

③ (MT매니저-수신 플로우 그림 8번)
MtMgrResultQueueListener::onMessage 
                    -> 단말기에서 메시지 수신(MSG.CMPL)
                    -> MtMgrService::searchOpenApiSendResultNotification (DB 전송결과조회)
                    -> MtMgrService::sendCallback(최종 결과 OpenAPI호출 그림 10번) -> ApiCallBackSender::sendApiCallBackRequest() -> MQ::API_CALLBACK

(그림 11번 ~ 13번)
ApiCallbackQueueListener::onMessageCommon -> (CRM에 Noti를 Http로 전송) -> AsynCustomerCallbackSender::run -> (CRM전송 결과 DB저장)

2. SKT SMS클라이언트
SmsSktClient::connection

## 메시지 발송(MT/MMS)
0. 쿼리/설정파일
mt.sqlmap.xml
api.properties.xml

1. MMS발송 요청
/v1/SendMms

2-1. 캐시접속 인증 및 API 권한 조회
OpenApiCommonFilter::doFilter -> CustomerCacheService::findCustomerInfo (캐시에서 User정보조회하고, 헤더에 키값: loginUser로  customerIpList와 리소스 리스트를 담는다)

2-2. 캐시실패 인증 및 API 권한 조회
OpenApiCommonFilter::doFilter -> CustomerCacheService::findCustomerInfo -> 예외발생
                              -> MtSendReqService::searchUserInfo
3. 사용 가능한 특번 조회
MtController::sendMms -> MtSendReqService::searchCheckValidationInfo(VO::SpcNum(스팩번호)) -> 실퍠경우(예외발생)

4. 첨부파일 검증
5. 첨부파일 저장(to 스토리지)
MtController::sendMms -> 테이블 COM_CD_GRP(ID:MMS_FILE_MIME_TP) 조회로 MIME타입 취득 -> 저장 -> ApiFileCommonUtil::multipartFileSave -> 존재여부/파일확장자 검증#


6. MMS발송 요청 정보 저장(to DB)
MtController::sendMms -> MessageStatus.WAIT -> MtSendReqService::createMtMmsMsgQueue 
                                                    -> DB: MT 발송 내역 등록 -> INSERT(MT_SND_REQ)
                                                    -> DB: MT 발송요청 상세정보 내역 등록 -> INSERT(MT_MSG_QUEUE)
                                                    -> DB: MT 발송요청 MMS 내 첨부파일 등록 -> INSERT(MT_MSG_QUEUE_BIN)

* MT_MSG_QUEUE: 전송중인 테이블

7. MMS발송 요청(MQ Push)
MtController::sendMms 
          -> MessageSubType.MMS 
          -> MessageStatus.WAIT 
          -> ApiSender::sendMtMgrRequest(MtMessage) -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH

8. MMS발송 요청 응답
MtController::sendMms -> resHeader(성공여부) GSON.toJson(resVO)

9. MMS 전송 결과 MQ Push
MtMgrRequestQueueListener::onMessage -> MtMgrService::searchMtMsgQueueInfo
                                        -> DB: 조회 -> SELECT(MT_MSG_QUEUE[userid, mtqueueid])
                                     -> DeviceCacheService::findDeviceInfo
                                        -> CACHE: 조회 -> JPA(device)
                                     -> MtMgrService::modifyMtMsgQueue -> MessageStatus.REQ or FAIL
                                        -> DB: 갱신 -> UPDATE(MT_MSG_QUEUE)
                                     -> 성공여부 
                                        -> 실패 -> MtMgrService::sendMtMgrReultByFinalFail
                                                    -> MtMgrResultSenderByFinalFail::sendMtMgrResult -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
                                        -> 성공
                                            -> SKT아닌경우(AGENT를 통해 발송)
                                                -> RlcAgentService::saveInfoBackMtMessage
                                            -> SKT경우
                                                -> MtMgrService::sendMsgReq (메시지별 직접 통신사 송신)
                                                -> SMS:MtSmsSender::sendMtSmsSktRequest -> MQ:PUSH
                                                -> LMS:MtMmsSender::sendMtMmsSktRequest -> MQ:PUSH
                                                -> MMS:MtMmsSender::sendMtMmsSktRequest -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH

9-1. SKT MMS Client (메시지 복호화 처리 -> 파일정보 -> 발송 큐에 적재)
MmsSktQueueListener::onMessage -> QueueName.MT_MMS.MT_MMS_SKT -> ::findMtMsgQueue -> MmsMtMessageService::findMtMessageQueue -> 메시지 복호화 처리
                                                                                        -> DB : 조회 -> SELECT(MT_MSG_QUEUE[mtqueueid])
                               -> RclID 없다면
                                  -> CustomerService::findCustomerDetail -> DB: RclID 조회 -> 존재여부 -> 실패 -> 예외
                               -> RclID 있다면 (단말기 발송처리!!!!)
                                  -> MmsSendManager::sendMessage -> MmsMtMessageService::searchMtMessageQueueFileList
                                                                      -> MmsMtMessageService::selectMtMsgQueueBinList
                                                                        -> DB: 단말기 MMS 첨부파일 조회 -> SELECT(MT_MSG_QUEUE_BIN)
                                                                      -> MmsSktClient::sendMessage -> queue:put
9-2. SKT MMS Client (발송 큐에서 메시지 취득후 발송후 단말로 부터 Submit RES 메시지 받는다. (발송에 대한 결과값이 반환이 아니다.))
MmsSktClient::run -> 연결이 끊어져있다면
                    -> Queue의 모든 메시지 -> MessageStatus.RETRY -> MmsSktQueueSender::sendMtMgrRequest
                  -> 연결되어 있다면
                    -> ::queue::poll -> CommonCode.MessageStatus.REQ -> MmsMtMessageService::modifyMtMessageQueue
                                                                          -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                                     -> ::sendMessage (실제 전송처리!!!)
                                          -> SktDeliverySubmit::toByte (메시지 전체 바이트 변환 - SOAP형태) -> 파일 전문 처리 -> 전체적으로 SOAP처리 -> 전체 byte변환
                                          -> OutputStream::write 

                                          ...ing...
                                          -> 최종 file에 대한 [덤프처리여부 => 덤프파일위치]덤프처리
                                          -> disconnect -> 연결끊음

10-1. VMG서버로 MMS전송 오류 결과는 MQ PUSH(대상: Retry/커넥션실패/실패) (문서: 7.4.1, 7.4.2) 응답성공은 발송이 성공한것이지 발송결과를 받은건 아니다.
MmsSktClient::run -> ::sendMessage -> 응답 -> SktMmsUtils::parserSubmitResult
                                       -> XML응답 파싱: MessageID, StatusCode, StatusText
                  -> ::callBackResult 
                     -> 응답성공 (응답의 상태코드로 판단)
                        -> MmsMtMessageService::saveMtMessageQueue 
                           -> CommonCode.MessageStatus.REQ -> updateMtMsgQueue (발송중으로 갱신)
                                                               -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> CommonCode.ProcessResult.SUCC -> insertMtMsgQueueActionHist (MT Action 이력 성공 처리)
                                                               -> DB: INSERT -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                     -> 응답실패 / Retry(응답의 상태코드로 판단)
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> CommonCode.MessageStatus.RETRY -> updateMtMsgQueue (발송중으로 갱신)
                                                                  -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> CommonCode.ProcessResult.FAIL -> insertMtMsgQueueActionHist (MT Action 이력 실패 처리)
                                                                  -> DB: INSERT -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                        -> MmsSktQueueSender::sendRetryMtMmsSkt 
                           -> MessageStatus.RETRY -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH
                     -> 응답실패 / 컨넥션 실패
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> CommonCode.MessageStatus.WAIT -> updateMtMsgQueue (갱신)
                                                                  -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> MmsSktQueueSender::sendMtMgrRequest
                              -> MessageStatus.RETRY -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH
                     -> 그외 전부 실패
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> CommonCode.MessageStatus.FAIL -> updateMtMsgQueue (실패 갱신)
                                                                  -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                        -> MmsSktQueueSender::sendMtMgrResult
                           -> MessageStatus.FAIL -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH

10-2. MMS 전송 결과 수신 (VMG서버로부터 HTTP로 전송 결과를 보내온다.)
uri: /mms/mt/skt/delivery_report
SktDeliveryReportController::deliveryReportReq 
               -> MmsSktReportService::saveDeliveryReport
                     -> CommonCode.MtActionType.REQUEST 
                     -> RESULT (성공)
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> MessageStatus.CMPL -> updateMtMsgQueue (완료)
                                 -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> CommonCode.ProcessResult.SUCC -> insertMtMsgQueueActionHist (MT Action 이력 성공 처리)
                                 -> DB: INSERT -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                     -> RESULT (통신사변경)
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> MessageStatus.RETRY -> updateMtMsgQueue (리트라이)
                                 -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> CommonCode.ProcessResult.FAIL -> insertMtMsgQueueActionHist
                                 -> DB: INSERT -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                     -> RESULT (리트라이)
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> MessageStatus.RETRY -> updateMtMsgQueue (리트라이)
                                 -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> CommonCode.ProcessResult.FAIL -> insertMtMsgQueueActionHist
                                 -> DB: INSERT -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                     -> RESULT (실패)
                        -> MmsMtMessageService::saveMtMessageQueue
                           -> MessageStatus.FAIL -> updateMtMsgQueue (실패)
                                 -> DB: 메시지 상태 변경 -> UPDATE(MT_MSG_QUEUE)
                           -> CommonCode.ProcessResult.FAIL -> insertMtMsgQueueActionHist
                                 -> DB: INSERT -> INSERT(MT_MSG_QUEUE_ACTION_HIST)
                  -> RESULT(성공)
                     -> MessageStatus.CMPL -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH 
                  -> RESULT(통신사변경)
                     -> MessageStatus.RETRY -> QueueName.MT_MGR.MT_MGR_REQUEST -> MQ:PUSH 
                  -> RESULT(리트라이)
                     -> MessageStatus.RETRY -> QueueName.MT_MMS.MT_MMS_SKT -> MQ:PUSH 
                  -> RESULT(실패)
                     -> MessageStatus.FAIL -> QueueName.MT_MGR.MT_MGR_RESULT -> MQ:PUSH
               -> 성공
                  -> MmsStatusCode.SUCCESS
               -> 실패
                  -> MmsStatusCode.SERVER_ERROR
               -> ::buildResponse (★:8 VMG버서에 응답 메시지는 SOAP 형식으로 전달한다.!!!!)

11. MMS 전송 결과 (QueueName.MT_MGR.MT_MGR_RESULT)
MtMgrResultQueueListener::onMessage -> MtMgrService::searchOpenApiSendResultNotification (조회)
                                          -> DB: MT_QUEUE_ID 조회 -> SELECT(MT_SND_HIST, CUSTOM, CRM_SERVER, SYSTEM_USER, MT_MSG_QUEUE)
                                    -> MtMgrService::modifyMtMgrResult(★:7)
                                          -> ... ing(상담/설문 비즈챗에 따라 분기 처리가 있다.)
                                    -> 성공 (MessageStatus.CMPL)
                                       -> CACHE: 발송 결과 성공인 경우 디비아스 정보를 저장
                                    -> MtMgrService::sendCallback(OpenAPI호출)
                                          -> ApiCallBackSender::sendApiCallBackRequest() -> QueueName.API.API_CALLBACK -> MQ:PUSH

12. MMS 전송결과 Notification 요청 (QueueName.API.API_CALLBACK)
ApiCallbackQueueListener::onMessageCommon -> MtSendReqService::searchOpenApiSendResultNotification
                                                -> DB: MT_QUEUE_ID 전송 결과 조회 -> SELECT(MT_SND_HIST, CUSTOM, CRM_SERVER, SYSTEM_USER, MT_MSG_QUEUE)
                                          -> ExecutorService::execute 
                                             -> AsynCustomerCallbackSender::run()
                                                -> CloseableHttpClient::execute(CRM에 Noti를 Http로 전송)
                                                -> 응답(13번으로...)
13. MMS 전송결과 Notification 응답
14. MMS 전송결과 Notification 응답코드 저장(DB)
AsynCustomerCallbackSender::run() -> 히스토리 여부 (응답코드 DB 저장)
                                       -> Y
                                          -> MtSendReqService::saveCustomNotificationResultToHistory
                                             -> MtSndHistMapper::updateMtSndHist
                                                -> DB: 히스토리 갱신 -> UPDATE(MT_SND_HIST)
                                             -> MtSndHistMapper::insertMtSndActionHist
                                                -> 성공/실패 (ProcessResult.SUCC/ProcessResult.FAIL)
                                                -> DB: 히스토리 저장 -> INSERT(MT_SND_ACTION_HIST)

                                       -> N
                                          -> MtSendReqService::saveCustomNotificationResult
                                             -> MtMapper::updateMtMsgQueue
                                                -> DB: 큐정보 -> UPDATE(MT_MSG_QUEUE)
                                             -> MtMapper::insertMtMsgQueueActionHist
                                                -> 성공/실패 (ProcessResult.SUCC/ProcessResult.FAIL)
                                                -> DB: 히스토리 저장 -> INSERT(MT_MSG_QUEUE_ACTION_HIST)

                                 -> 실패
                                       -> RetrySender::sendApiCallbackRetry -> QueueName.API.API_CALLBACK_RETRY